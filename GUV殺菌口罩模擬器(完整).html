<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GUVæ®ºèŒå£ç½©æ¨¡æ“¬å™¨</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .main-panel {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .device-display {
            background: #2c3e50;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            color: white;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
        }
        
        .device-name {
            font-size: 18px;
            margin-bottom: 20px;
            opacity: 0.8;
        }
        
        .lights-panel {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        .light {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid #444;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .light.green.on {
            background: #2ecc71;
            box-shadow: 0 0 20px #2ecc71;
            border-color: #27ae60;
        }
        
        .light.red.on {
            background: #e74c3c;
            box-shadow: 0 0 20px #e74c3c;
            border-color: #c0392b;
        }
        
        .light.red.blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        .light.off {
            background: #34495e;
        }
        
        .fan-display {
            margin: 20px 0;
            font-size: 24px;
        }
        
        .fan-icon {
            display: inline-block;
            font-size: 40px;
            margin: 10px;
            transition: all 0.3s ease;
        }
        
        .fan-icon.speed1 {
            animation: rotate 2s linear infinite;
        }
        
        .fan-icon.speed2 {
            animation: rotate 1s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .state-info {
            background: rgba(52, 73, 94, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .current-state {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .state-description {
            color: #7f8c8d;
            line-height: 1.6;
        }
        
        .controls {
            background: #ecf0f1;
            border-radius: 15px;
            padding: 25px;
        }
        
        .controls h3 {
            margin-top: 0;
            color: #2c3e50;
            text-align: center;
        }
        
        .button-group {
            margin-bottom: 20px;
        }
        
        .button-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #34495e;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            margin: 5px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .btn-success {
            background: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        .power-button {
            position: relative;
            overflow: hidden;
            user-select: none;
        }
        
        .power-button:active {
            background: #2980b9;
            transform: translateY(1px);
        }
        
        .press-indicator {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background: #f39c12;
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 0 0 8px 8px;
        }
        
        .countdown-display {
            background: rgba(231, 76, 60, 0.1);
            border: 2px solid #e74c3c;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
            color: #e74c3c;
        }
        
        .countdown-number {
            font-size: 24px;
            margin: 5px 0;
        }
        
        .countdown-bar {
            width: 100%;
            height: 8px;
            background: rgba(231, 76, 60, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .countdown-progress {
            height: 100%;
            background: #e74c3c;
            border-radius: 4px;
            transition: width 0.1s linear;
        }
        
        .status-panel {
            background: #ecf0f1;
            border-radius: 15px;
            padding: 25px;
        }
        
        .status-panel h3 {
            margin-top: 0;
            color: #2c3e50;
            text-align: center;
        }
        
        .status-item {
            margin: 15px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .status-label {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .status-value {
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .log-panel {
            margin-top: 30px;
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 15px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        .log-panel h3 {
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
        }
        
        #logContainer {
            position: relative;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 8px 12px;
            border-left: 3px solid #3498db;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 3px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .log-entry.detailed {
            border-left-color: #f39c12;
            background: rgba(243, 156, 18, 0.1);
        }
        
        .log-entry.auto-check {
            border-left-color: #9b59b6;
            background: rgba(155, 89, 182, 0.1);
        }
        
        .log-entry.transition {
            border-left-color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
        }
        
        .log-entry.error {
            border-left-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }
        
        .log-time {
            font-size: 12px;
            opacity: 0.7;
        }
        
        .log-reason {
            font-size: 12px;
            color: #bdc3c7;
            margin-top: 2px;
            font-style: italic;
        }
        
        .toggle-container {
            margin: 15px 0;
        }
        
        .toggle-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #34495e;
            font-size: 14px;
        }
        
        .toggle-switch {
            width: 100%;
            height: 40px;
            background: #bdc3c7;
            border-radius: 20px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .toggle-switch.active {
            background: #2ecc71;
        }
        
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            background: white;
            border-radius: 18px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
        }
        
        .toggle-switch.active .toggle-slider {
            background: #27ae60;
            color: white;
        }
        
        .battery-flags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .flag-btn {
            flex: 1;
            min-width: 60px;
            padding: 8px 12px;
            border: 2px solid #bdc3c7;
            background: #ecf0f1;
            color: #7f8c8d;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .flag-btn:hover {
            border-color: #95a5a6;
        }
        
        .flag-btn.active {
            border-color: #3498db;
            background: #3498db;
            color: white;
        }
        
        .flag-btn.low.active {
            border-color: #e74c3c;
            background: #e74c3c;
        }
        
        .available-actions {
            margin-top: 15px;
            font-size: 14px;
            color: #7f8c8d;
            line-height: 1.6;
        }
        
        /* ç‹€æ…‹è½‰ç§»åœ–MAPæ¨£å¼ - é‡‘å­—å¡”å¸ƒå±€ */
        .state-map-panel {
            grid-column: 1 / -1;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
            border: 2px solid #dee2e6;
        }
        
        .state-map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .state-map-header h3 {
            margin: 0;
            color: #2c3e50;
        }
        
        .map-toggle-btn {
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .map-toggle-btn:hover {
            background: #2980b9;
        }
        
        .state-map {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
            margin-top: 20px;
        }
        
        .map-row {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            width: 100%;
        }
        
        .map-row.top {
            /* æœ€ä¸Šå±¤ï¼šåˆå§‹ç‹€æ…‹çµ„ - 1å€‹ */
            justify-content: center;
        }
        
        .map-row.middle {
            /* ä¸­å±¤ï¼šä¸‰å€‹é‹è¡Œç‹€æ…‹çµ„ - 3å€‹ä¸¦æ’ */
            justify-content: space-around;
            max-width: 900px;
        }
        
        .map-row.bottom {
            /* åº•å±¤ï¼šç•°å¸¸ç‹€æ…‹ - 1å€‹ */
            justify-content: center;
        }
        
        .state-group {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
            min-width: 220px;
            max-width: 280px;
            flex: 1;
        }
        
        .state-group.active {
            border-color: #3498db;
            box-shadow: 0 4px 16px rgba(52, 152, 219, 0.3);
            transform: translateY(-2px);
        }
        
        /* é‡å°ä¸åŒå±¤ç´šçš„ç‰¹æ®Šæ¨£å¼ */
        .map-row.top .state-group {
            min-width: 300px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .map-row.middle .state-group {
            min-width: 200px;
            max-width: 250px;
        }
        
        .map-row.bottom .state-group {
            min-width: 250px;
            background: rgba(231, 76, 60, 0.05);
            border-color: rgba(231, 76, 60, 0.2);
        }
        
        .group-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
        }
        
        .group-title.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        
        .state-item {
            margin: 8px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 12px;
            color: #6c757d;
            border-left: 3px solid #dee2e6;
            transition: all 0.3s ease;
        }
        
        .state-item.current {
            background: #3498db;
            color: white;
            border-left-color: #2980b9;
            font-weight: bold;
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.4);
        }
        
        .state-item.possible {
            background: #e8f5e8;
            color: #27ae60;
            border-left-color: #27ae60;
        }
        
        .state-item.transitioning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
            border-left-color: #d35400;
            font-weight: bold;
            animation: pulse 0.8s ease-in-out;
            box-shadow: 0 2px 8px rgba(243, 156, 18, 0.4);
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }
        
        .state-item.protection {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border-left-color: #a93226;
            font-weight: bold;
            animation: protectionPulse 1.5s ease-in-out infinite;
            box-shadow: 0 2px 12px rgba(231, 76, 60, 0.5);
        }
        
        @keyframes protectionPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 2px 12px rgba(231, 76, 60, 0.5);
            }
            50% { 
                transform: scale(1.1);
                box-shadow: 0 4px 20px rgba(231, 76, 60, 0.8);
            }
        }
        
        @media (max-width: 1200px) {
            .map-row.middle {
                max-width: 600px;
            }
            .state-group {
                min-width: 180px;
                max-width: 220px;
            }
        }
        
        @media (max-width: 768px) {
            .main-panel {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .map-row.middle {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .state-group {
                min-width: 280px;
                max-width: 320px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦  GUVæ®ºèŒå£ç½© æ¨¡æ“¬å™¨ - å¼·åŒ–ç‰ˆ</h1>
            <p>æ¨¡æ“¬GUVæ®ºèŒå£ç½©è¨­å‚™çš„å®Œæ•´ç‹€æ…‹è½‰æ›æµç¨‹ | æ–°å¢ç‹€æ…‹è½‰ç§»åœ–MAPèˆ‡è©³ç´°æ—¥èªŒ</p>
        </div>
        
        <!-- ç‹€æ…‹è½‰ç§»åœ–MAP - é‡‘å­—å¡”æ’åˆ— -->
        <div class="state-map-panel" id="stateMapPanel">
            <div class="state-map-header">
                <h3>ğŸ—ºï¸ ç‹€æ…‹è½‰ç§»åœ– MAP</h3>
                <button class="map-toggle-btn" onclick="toggleStateMap()" id="mapToggleBtn">é¡¯ç¤ºMAP</button>
            </div>
            <div class="state-map" id="stateMapContainer" style="display: none;">
                <!-- æœ€ä¸Šå±¤ï¼šåˆå§‹ç‹€æ…‹çµ„ -->
                <div class="map-row top">
                    <div class="state-group" id="initialGroup">
                        <div class="group-title">ğŸš€ åˆå§‹ç‹€æ…‹çµ„</div>
                        <div class="state-item" data-state="S0">S0: åˆå§‹ç‹€æ…‹</div>
                        <div class="state-item" data-state="C0">C0: å……é›»åˆå§‹ç‹€æ…‹</div>
                        <div class="state-item" data-state="A0">A0: æ»¿å……é›»åˆå§‹ç‹€æ…‹</div>
                    </div>
                </div>
                
                <!-- ä¸­å±¤ï¼šä¸‰å€‹é‹è¡Œç‹€æ…‹çµ„ -->
                <div class="map-row middle">
                    <div class="state-group" id="batteryGroup">
                        <div class="group-title">ğŸ”‹ é›»æ± é‹è¡Œç‹€æ…‹çµ„</div>
                        <div class="state-item" data-state="S1">S1: é›»æ± ä¾›é›»é¢¨æ‰‡1é€Ÿ</div>
                        <div class="state-item" data-state="S2">S2: é›»æ± ä¾›é›»é¢¨æ‰‡2é€Ÿ</div>
                    </div>
                    
                    <div class="state-group" id="chargingGroup">
                        <div class="group-title">âš¡ å……é›»é‹è¡Œç‹€æ…‹çµ„</div>
                        <div class="state-item" data-state="C1">C1: å……é›»å™¨ä¾›é›»é¢¨æ‰‡1é€Ÿ</div>
                        <div class="state-item" data-state="C2">C2: å……é›»å™¨ä¾›é›»é¢¨æ‰‡2é€Ÿ</div>
                    </div>
                    
                    <div class="state-group" id="fullChargedGroup">
                        <div class="group-title">ğŸ”‹ğŸ’¯ æ»¿å……é›»é‹è¡Œç‹€æ…‹çµ„</div>
                        <div class="state-item" data-state="A1">A1: æ»¿å……ä¸‹é¢¨æ‰‡1é€Ÿ</div>
                        <div class="state-item" data-state="A2">A2: æ»¿å……ä¸‹é¢¨æ‰‡2é€Ÿ</div>
                    </div>
                </div>
                
                <!-- åº•å±¤ï¼šç•°å¸¸ç‹€æ…‹ -->
                <div class="map-row bottom">
                    <div class="state-group" id="exceptionGroup">
                        <div class="group-title">âš ï¸ ç•°å¸¸ç‹€æ…‹</div>
                        <div class="state-item" data-state="S3">S3: é›»æ± ä½é›»é‡ä¿è­·</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-panel">
            <div class="controls">
                <h3>âš¡ æ§åˆ¶é¢æ¿</h3>
                
                <div class="button-group">
                    <label>æŒ‰éµæ“ä½œ</label>
                    <button class="btn btn-primary power-button" 
                            onmousedown="startPress()" 
                            onmouseup="endPress()" 
                            onmouseleave="endPress()"
                            ontouchstart="startPress()" 
                            ontouchend="endPress()"
                            id="powerButton">
                        <span id="buttonText">æŒ‰ä½é–‹é—œ</span>
                        <div class="press-indicator" id="pressIndicator"></div>
                    </button>
                </div>
                
                <div class="button-group">
                    <label>é›»æºç®¡ç†</label>
                    <div class="toggle-container">
                        <label class="toggle-label">å……é›»å™¨ç‹€æ…‹</label>
                        <div class="toggle-switch" onclick="toggleCharger()">
                            <div class="toggle-slider" id="chargerToggle">
                                <span class="toggle-text" id="chargerToggleText">æœªé€£æ¥</span>
                            </div>
                        </div>
                    </div>
                    <div class="toggle-container">
                        <label class="toggle-label">é›»æ± ç‹€æ…‹</label>
                        <div class="battery-flags">
                            <button class="flag-btn" id="batteryNormalFlag" onclick="setBatteryStatus('normal')">æ­£å¸¸</button>
                            <button class="flag-btn" id="batteryLowFlag" onclick="setBatteryStatus('low')">ä½é›»é‡</button>
                            <button class="flag-btn" id="batteryFullFlag" onclick="setBatteryStatus('full')">å·²å……æ»¿</button>
                        </div>
                    </div>
                </div>
                
                <div class="button-group">
                    <label>ç³»çµ±æ¨¡æ“¬</label>
                    <button class="btn btn-primary" onclick="resetSystem()">ç³»çµ±é‡ç½®</button>
                </div>
            </div>
            
            <div class="device-display">
                <div class="device-name">GUVæ®ºèŒå£ç½©è¨­å‚™</div>
                
                <div class="lights-panel">
                    <div>
                        <div class="light green" id="greenLight"></div>
                        <div style="margin-top: 8px; font-size: 12px;">ç¶ ç‡ˆ</div>
                    </div>
                    <div>
                        <div class="light red" id="redLight"></div>
                        <div style="margin-top: 8px; font-size: 12px;">ç´…ç‡ˆ</div>
                    </div>
                </div>
                
                <div class="fan-display">
                    <div class="fan-icon" id="fanIcon">ğŸŒ€</div>
                    <div id="fanStatus">é¢¨æ‰‡é—œé–‰</div>
                </div>
                
                <div class="state-info">
                    <div class="current-state" id="currentState">S0: åˆå§‹ç‹€æ…‹</div>
                    <div class="state-description" id="stateDescription">è¨­å‚™è™•æ–¼å®Œå…¨é—œé–‰çš„ç‹€æ…‹</div>
                    <div class="available-actions" id="availableActions">
                        å¯ç”¨æ“ä½œï¼šé•·æŒ‰é–‹é—œï¼ˆé€²å…¥S1ï¼‰ï¼Œç¢ºèªå……é›»ï¼ˆé€²å…¥C0ï¼‰
                    </div>
                    
                    <!-- S3ç‹€æ…‹çš„å€’æ•¸é¡¯ç¤º -->
                    <div class="countdown-display" id="countdownDisplay" style="display: none;">
                        <div>ä½é›»é‡ä¿è­·æ¨¡å¼</div>
                        <div class="countdown-number" id="countdownNumber">10</div>
                        <div>ç§’å¾Œè‡ªå‹•è¿”å›</div>
                        <div class="countdown-bar">
                            <div class="countdown-progress" id="countdownProgress"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="status-panel">
                <h3>ğŸ“Š ç³»çµ±ç‹€æ…‹</h3>
                
                <div class="status-item">
                    <div class="status-label">ç•¶å‰ç‹€æ…‹</div>
                    <div class="status-value" id="statusState">S0</div>
                </div>
                
                <div class="status-item">
                    <div class="status-label">é›»æ± ç‹€æ…‹</div>
                    <div class="status-value" id="batteryStatus">æ­£å¸¸</div>
                </div>
                
                <div class="status-item">
                    <div class="status-label">å……é›»ç‹€æ…‹</div>
                    <div class="status-value" id="chargerStatus">æœªé€£æ¥</div>
                </div>
                
                <div class="status-item">
                    <div class="status-label">é¢¨æ‰‡é€Ÿåº¦</div>
                    <div class="status-value" id="fanSpeed">é—œé–‰</div>
                </div>
                
                <div class="status-item">
                    <div class="status-label">æŒ‰éµç‹€æ…‹</div>
                    <div class="status-value" id="buttonStatus">å•Ÿç”¨</div>
                </div>
            </div>
        </div>
        
        <div class="log-panel">
            <h3>ğŸ“ è©³ç´°æ“ä½œæ—¥èªŒ</h3>
            <div id="logContainer">
                <div class="log-entry">
                    <span class="log-time">[ç³»çµ±å•Ÿå‹•]</span> è¨­å‚™å·²åˆå§‹åŒ–è‡³ S0 ç‹€æ…‹
                    <div class="log-reason">åˆå§‹åŒ–å®Œæˆï¼Œæ‰€æœ‰ç¡¬é«”çµ„ä»¶è™•æ–¼é è¨­ç‹€æ…‹</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç‹€æ…‹æ©Ÿå®šç¾©
        const states = {
            S0: { name: 'S0: åˆå§‹ç‹€æ…‹', green: false, red: false, fan: 0, desc: 'è¨­å‚™è™•æ–¼å®Œå…¨é—œé–‰çš„ç‹€æ…‹', actions: 'å¯ç”¨æ“ä½œï¼šé•·æŒ‰é–‹é—œï¼ˆé€²å…¥S1ï¼‰ï¼Œç¢ºèªå……é›»ï¼ˆé€²å…¥C0ï¼‰', group: 'initial' },
            S1: { name: 'S1: é›»æ± ä¾›é›»é¢¨æ‰‡1é€Ÿ', green: true, red: false, fan: 1, desc: 'è¨­å‚™ä»¥é›»æ± é›»æºé‹è¡Œåœ¨ä½é€Ÿæ¨¡å¼', actions: 'å¯ç”¨æ“ä½œï¼šçŸ­æŒ‰é–‹é—œï¼ˆé€²å…¥S2ï¼‰ã€é•·æŒ‰é–‹é—œï¼ˆè¿”å›S0ï¼‰ã€ç¢ºèªå……é›»ï¼ˆé€²å…¥C1ï¼‰', group: 'battery' },
            S2: { name: 'S2: é›»æ± ä¾›é›»é¢¨æ‰‡2é€Ÿ', green: true, red: false, fan: 2, desc: 'è¨­å‚™ä»¥é›»æ± é›»æºé‹è¡Œåœ¨é«˜é€Ÿæ¨¡å¼', actions: 'å¯ç”¨æ“ä½œï¼šçŸ­æŒ‰é–‹é—œï¼ˆè¿”å›S1ï¼‰ã€é•·æŒ‰é–‹é—œï¼ˆè¿”å›S0ï¼‰ã€ç¢ºèªå……é›»ï¼ˆé€²å…¥C2ï¼‰', group: 'battery' },
            S3: { name: 'S3: é›»æ± ä½é›»é‡', green: false, red: 'blink', fan: 0, desc: 'è¨­å‚™æª¢æ¸¬åˆ°ä½é›»å£“ï¼Œé€²å…¥ä¿è­·æ¨¡å¼', actions: 'æŒ‰éµç¦ç”¨ï¼Œè‡ªå‹•è¿”å›S0æˆ–é›»å£“æ¢å¾©', group: 'exception' },
            C0: { name: 'C0: å……é›»åˆå§‹ç‹€æ…‹', green: false, red: true, fan: 0, desc: 'è¨­å‚™å·²é€£æ¥å……é›»æºä½†æœªé‹è¡Œé¢¨æ‰‡', actions: 'å¯ç”¨æ“ä½œï¼šé•·æŒ‰é–‹é—œï¼ˆé€²å…¥C1ï¼‰ã€é›»æ± å……æ»¿ï¼ˆé€²å…¥A0ï¼‰', group: 'initial' },
            C1: { name: 'C1: å……é›»å™¨ä¾›é›»é¢¨æ‰‡1é€Ÿ', green: true, red: true, fan: 1, desc: 'è¨­å‚™åœ¨å……é›»åŒæ™‚ä»¥ä½é€Ÿé‹è¡Œé¢¨æ‰‡', actions: 'å¯ç”¨æ“ä½œï¼šçŸ­æŒ‰é–‹é—œï¼ˆé€²å…¥C2ï¼‰ã€é•·æŒ‰é–‹é—œï¼ˆè¿”å›S0ï¼‰ã€ç§»é™¤å……é›»ï¼ˆé€²å…¥S1ï¼‰', group: 'charging' },
            C2: { name: 'C2: å……é›»å™¨ä¾›é›»é¢¨æ‰‡2é€Ÿ', green: true, red: true, fan: 2, desc: 'è¨­å‚™åœ¨å……é›»åŒæ™‚ä»¥é«˜é€Ÿé‹è¡Œé¢¨æ‰‡', actions: 'å¯ç”¨æ“ä½œï¼šçŸ­æŒ‰é–‹é—œï¼ˆè¿”å›C1ï¼‰ã€é•·æŒ‰é–‹é—œï¼ˆè¿”å›S0ï¼‰ã€ç§»é™¤å……é›»ï¼ˆé€²å…¥S2ï¼‰', group: 'charging' },
            A0: { name: 'A0: æ»¿å……é›»åˆå§‹ç‹€æ…‹', green: false, red: false, fan: 0, desc: 'è¨­å‚™åœ¨é›»æ± å……æ»¿æ™‚çš„ç‹€æ…‹', actions: 'å¯ç”¨æ“ä½œï¼šé•·æŒ‰é–‹é—œï¼ˆé€²å…¥A1ï¼‰', group: 'initial' },
            A1: { name: 'A1: æ»¿å……ä¸‹é¢¨æ‰‡1é€Ÿ', green: true, red: false, fan: 1, desc: 'è¨­å‚™ç›´æ¥ä½¿ç”¨äº¤æµé›»æºä»¥ä½é€Ÿé‹è¡Œ', actions: 'å¯ç”¨æ“ä½œï¼šçŸ­æŒ‰é–‹é—œï¼ˆé€²å…¥A2ï¼‰ã€ç§»é™¤å……é›»ï¼ˆå–æ±ºæ–¼é›»æ± ç‹€æ…‹ï¼‰', group: 'fullcharged' },
            A2: { name: 'A2: æ»¿å……ä¸‹é¢¨æ‰‡2é€Ÿ', green: true, red: false, fan: 2, desc: 'è¨­å‚™ç›´æ¥ä½¿ç”¨äº¤æµé›»æºä»¥é«˜é€Ÿé‹è¡Œ', actions: 'å¯ç”¨æ“ä½œï¼šçŸ­æŒ‰é–‹é—œï¼ˆè¿”å›A1ï¼‰ã€ç§»é™¤å……é›»ï¼ˆå–æ±ºæ–¼é›»æ± ç‹€æ…‹ï¼‰', group: 'fullcharged' }
        };

        // ç‹€æ…‹çµ„å°æ‡‰é—œä¿‚
        const stateGroups = {
            'initial': ['S0', 'C0', 'A0'],
            'battery': ['S1', 'S2'],
            'charging': ['C1', 'C2'],
            'fullcharged': ['A1', 'A2'],
            'exception': ['S3']
        };

        // ç³»çµ±ç‹€æ…‹
        let currentState = 'S0';
        let chargerConnected = false;
        let batteryLevel = 'normal'; // normal, low, full
        let lowVoltageTimer = null;
        let countdownTimer = null;
        let countdownSeconds = 0;
        let stateMapVisible = true;
        
        // æŒ‰éµç‹€æ…‹
        let pressTimer = null;
        let isPressed = false;
        let pressStartTime = 0;
        const LONG_PRESS_DURATION = 1000; // 1ç§’ç‚ºé•·æŒ‰

        // åˆå§‹åŒ–
        window.onload = function() {
            updateDisplay();
            updateStateMap();
            // è¨­å®šåˆå§‹æ——æ¨™ç‹€æ…‹
            document.getElementById('batteryNormalFlag').classList.add('active');
        };

        // ç‹€æ…‹è½‰ç§»åœ–MAPæ§åˆ¶
        function toggleStateMap() {
            const mapContainer = document.getElementById('stateMapContainer');
            const toggleBtn = document.getElementById('mapToggleBtn');
            
            if (stateMapVisible) {
                mapContainer.style.display = 'none';
                toggleBtn.textContent = 'é¡¯ç¤ºMAP';
                stateMapVisible = false;
                addDetailedLog('ç³»çµ±æ“ä½œ', 'MAPåŠŸèƒ½å·²éš±è—', 'auto-check');
            } else {
                mapContainer.style.display = 'flex';
                toggleBtn.textContent = 'éš±è—MAP';
                stateMapVisible = true;
                addDetailedLog('ç³»çµ±æ“ä½œ', 'MAPåŠŸèƒ½å·²é¡¯ç¤º', 'auto-check');
            }
        }

        function showTransitionEffect(targetState, duration = 800) {
            const targetStateItem = document.querySelector(`[data-state="${targetState}"]`);
            if (targetStateItem) {
                if (targetState === 'S3') {
                    // S3ä¿è­·ç‹€æ…‹ä½¿ç”¨ç‰¹æ®Šæ•ˆæœ
                    targetStateItem.classList.add('protection');
                    setTimeout(() => {
                        targetStateItem.classList.remove('protection');
                    }, duration);
                } else {
                    // å…¶ä»–ç‹€æ…‹ä½¿ç”¨ä¸€èˆ¬éæ¸¡æ•ˆæœ
                    targetStateItem.classList.add('transitioning');
                    setTimeout(() => {
                        targetStateItem.classList.remove('transitioning');
                    }, duration);
                }
            }
        }

        function updateStateMap() {
            // æ¸…é™¤æ‰€æœ‰é«˜äº®
            document.querySelectorAll('.state-group').forEach(group => {
                group.classList.remove('active');
            });
            document.querySelectorAll('.group-title').forEach(title => {
                title.classList.remove('active');
            });
            document.querySelectorAll('.state-item').forEach(item => {
                item.classList.remove('current', 'possible');
            });

            // é«˜äº®ç•¶å‰ç‹€æ…‹æ‰€å±¬çš„ç¾¤çµ„
            const currentGroup = states[currentState].group;
            const groupMapping = {
                'initial': 'initialGroup',
                'battery': 'batteryGroup', 
                'charging': 'chargingGroup',
                'fullcharged': 'fullChargedGroup',
                'exception': 'exceptionGroup'
            };
            
            const activeGroupElement = document.getElementById(groupMapping[currentGroup]);
            if (activeGroupElement) {
                activeGroupElement.classList.add('active');
                activeGroupElement.querySelector('.group-title').classList.add('active');
            }

            // é«˜äº®ç•¶å‰ç‹€æ…‹
            const currentStateItem = document.querySelector(`[data-state="${currentState}"]`);
            if (currentStateItem) {
                currentStateItem.classList.add('current');
            }

            // æ¨™ç¤ºå¯èƒ½çš„ä¸‹ä¸€å€‹ç‹€æ…‹
            const possibleStates = getPossibleNextStates();
            possibleStates.forEach(state => {
                const stateItem = document.querySelector(`[data-state="${state}"]`);
                if (stateItem && state !== currentState) {
                    stateItem.classList.add('possible');
                }
            });
        }

        function getPossibleNextStates() {
            const possible = [];
            
            switch(currentState) {
                case 'S0':
                    // é•·æŒ‰é–‹é—œçš„å¯èƒ½è·¯å¾‘ï¼ˆæ ¹æ“šç•¶å‰å……é›»å™¨å’Œé›»æ± ç‹€æ…‹ï¼‰
                    if (!chargerConnected) {
                        possible.push('S1'); // ç„¡å……é›»å™¨ â†’ ç›´æ¥é›»æ± æ¨¡å¼
                    } else {
                        if (batteryLevel === 'full') {
                            possible.push('A1'); // æœ‰å……é›»å™¨ + é›»æ± æ»¿ â†’ æ»¿å……é›»æ¨¡å¼
                        } else {
                            possible.push('C1'); // æœ‰å……é›»å™¨ + é›»æ± æœªæ»¿ â†’ å……é›»æ¨¡å¼
                        }
                    }
                    
                    // é€£æ¥/æ–·é–‹å……é›»å™¨çš„å¯èƒ½è·¯å¾‘
                    if (!chargerConnected) {
                        // ç•¶å‰ç„¡å……é›»å™¨ï¼Œå¯èƒ½é€£æ¥å……é›»å™¨
                        if (batteryLevel === 'full') {
                            possible.push('C0', 'A0'); // é€£æ¥å……é›»å™¨ â†’ C0 â†’ A0
                        } else {
                            possible.push('C0'); // é€£æ¥å……é›»å™¨ â†’ C0
                        }
                    }
                    
                    // é›»æ± ç‹€æ…‹è®ŠåŒ–çš„å¯èƒ½æ€§ï¼ˆåœ¨æœ‰å……é›»å™¨æ™‚ï¼‰
                    if (chargerConnected) {
                        if (batteryLevel !== 'full') {
                            possible.push('A0'); // é›»æ± å¯èƒ½å……æ»¿
                        }
                        if (batteryLevel !== 'normal') {
                            possible.push('C0'); // é›»æ± å¯èƒ½è®Šæ­£å¸¸
                        }
                    }
                    break;
                    
                case 'S1':
                    possible.push('S2'); // çŸ­æŒ‰é–‹é—œ
                    
                    // é•·æŒ‰é–‹é—œçš„è·¯å¾‘
                    if (!chargerConnected) {
                        possible.push('S0'); // ç„¡å……é›»å™¨æ™‚ç›´æ¥é—œæ©Ÿ
                    } else {
                        possible.push('C0'); // æœ‰å……é›»å™¨æ™‚é€²å…¥å……é›»æ¨¡å¼
                    }
                    
                    // é€£æ¥å……é›»å™¨
                    if (!chargerConnected) {
                        possible.push('C1'); // é€£æ¥å……é›»å™¨ä¿æŒåŒé€Ÿåº¦
                    }
                    
                    // é›»æ± ç‹€æ…‹è®ŠåŒ–
                    if (batteryLevel !== 'low') {
                        possible.push('S3'); // å¯èƒ½è®Šä½é›»é‡
                    }
                    break;
                    
                case 'S2':
                    possible.push('S1'); // çŸ­æŒ‰é–‹é—œ
                    
                    // é•·æŒ‰é–‹é—œçš„è·¯å¾‘
                    if (!chargerConnected) {
                        possible.push('S0'); // ç„¡å……é›»å™¨æ™‚ç›´æ¥é—œæ©Ÿ
                    } else {
                        possible.push('C0'); // æœ‰å……é›»å™¨æ™‚é€²å…¥å……é›»æ¨¡å¼
                    }
                    
                    // é€£æ¥å……é›»å™¨
                    if (!chargerConnected) {
                        possible.push('C2'); // é€£æ¥å……é›»å™¨ä¿æŒåŒé€Ÿåº¦
                    }
                    
                    // é›»æ± ç‹€æ…‹è®ŠåŒ–
                    if (batteryLevel !== 'low') {
                        possible.push('S3'); // å¯èƒ½è®Šä½é›»é‡
                    }
                    break;
                    
                case 'C0':
                    possible.push('C1'); // é•·æŒ‰é–‹é—œ
                    
                    // ç§»é™¤å……é›»å™¨
                    if (chargerConnected) {
                        possible.push('S0'); // ç§»é™¤å……é›»å™¨å›åˆ°åˆå§‹ç‹€æ…‹
                    }
                    
                    // é›»æ± ç‹€æ…‹è®ŠåŒ–
                    if (batteryLevel !== 'full') {
                        possible.push('A0'); // é›»æ± å¯èƒ½å……æ»¿
                    }
                    break;
                    
                case 'C1':
                    possible.push('C2'); // çŸ­æŒ‰é–‹é—œ
                    possible.push('C0'); // é•·æŒ‰é–‹é—œ
                    
                    // ç§»é™¤å……é›»å™¨
                    if (chargerConnected) {
                        possible.push('S1'); // ç§»é™¤å……é›»å™¨è½‰ç‚ºé›»æ± æ¨¡å¼
                        possible.push('S0'); // é•·æŒ‰é—œæ©Ÿæ™‚å¦‚æœç§»é™¤å……é›»å™¨
                    }
                    
                    // é›»æ± ç‹€æ…‹è®ŠåŒ–
                    if (batteryLevel !== 'full') {
                        possible.push('A1'); // é›»æ± å¯èƒ½å……æ»¿
                    }
                    if (batteryLevel !== 'low') {
                        possible.push('S3'); // å¯èƒ½è®Šä½é›»é‡
                    }
                    break;
                    
                case 'C2':
                    possible.push('C1'); // çŸ­æŒ‰é–‹é—œ
                    possible.push('C0'); // é•·æŒ‰é–‹é—œ
                    
                    // ç§»é™¤å……é›»å™¨
                    if (chargerConnected) {
                        possible.push('S2'); // ç§»é™¤å……é›»å™¨è½‰ç‚ºé›»æ± æ¨¡å¼
                        possible.push('S0'); // é•·æŒ‰é—œæ©Ÿæ™‚å¦‚æœç§»é™¤å……é›»å™¨
                    }
                    
                    // é›»æ± ç‹€æ…‹è®ŠåŒ–
                    if (batteryLevel !== 'full') {
                        possible.push('A2'); // é›»æ± å¯èƒ½å……æ»¿
                    }
                    if (batteryLevel !== 'low') {
                        possible.push('S3'); // å¯èƒ½è®Šä½é›»é‡
                    }
                    break;
                    
                case 'A0':
                    possible.push('A1'); // é•·æŒ‰é–‹é—œ
                    
                    // ç§»é™¤å……é›»å™¨
                    if (chargerConnected) {
                        possible.push('S0'); // ç§»é™¤å……é›»å™¨å›åˆ°åˆå§‹ç‹€æ…‹
                    }
                    
                    // é›»æ± ç‹€æ…‹è®ŠåŒ–
                    if (batteryLevel === 'full') {
                        possible.push('C0'); // é›»æ± å¯èƒ½è®Šæ­£å¸¸
                    }
                    break;
                    
                case 'A1':
                    possible.push('A2'); // çŸ­æŒ‰é–‹é—œ
                    possible.push('A0'); // é•·æŒ‰é–‹é—œ
                    
                    // ç§»é™¤å……é›»å™¨
                    if (chargerConnected) {
                        possible.push('S1'); // ç§»é™¤å……é›»å™¨è½‰ç‚ºé›»æ± æ¨¡å¼
                        possible.push('S0'); // é•·æŒ‰é—œæ©Ÿæ™‚å¦‚æœç§»é™¤å……é›»å™¨
                    }
                    
                    // é›»æ± ç‹€æ…‹è®ŠåŒ–
                    if (batteryLevel === 'full') {
                        possible.push('C1'); // é›»æ± å¯èƒ½è®Šæ­£å¸¸
                    }
                    if (batteryLevel !== 'low') {
                        possible.push('S3'); // å¯èƒ½è®Šä½é›»é‡
                    }
                    break;
                    
                case 'A2':
                    possible.push('A1'); // çŸ­æŒ‰é–‹é—œ
                    possible.push('A0'); // é•·æŒ‰é–‹é—œ
                    
                    // ç§»é™¤å……é›»å™¨
                    if (chargerConnected) {
                        possible.push('S2'); // ç§»é™¤å……é›»å™¨è½‰ç‚ºé›»æ± æ¨¡å¼
                        possible.push('S0'); // é•·æŒ‰é—œæ©Ÿæ™‚å¦‚æœç§»é™¤å……é›»å™¨
                    }
                    
                    // é›»æ± ç‹€æ…‹è®ŠåŒ–
                    if (batteryLevel === 'full') {
                        possible.push('C2'); // é›»æ± å¯èƒ½è®Šæ­£å¸¸
                    }
                    if (batteryLevel !== 'low') {
                        possible.push('S3'); // å¯èƒ½è®Šä½é›»é‡
                    }
                    break;
                    
                case 'S3':
                    // å€’æ•¸çµæŸæˆ–é›»æ± æ¢å¾©çš„å¯èƒ½è·¯å¾‘
                    if (chargerConnected) {
                        possible.push('C0'); // æœ‰å……é›»å™¨æ™‚è¿”å›å……é›»æ¨¡å¼
                    } else {
                        possible.push('S0'); // ç„¡å……é›»å™¨æ™‚è¿”å›åˆå§‹ç‹€æ…‹
                    }
                    
                    // é›»æ± ç‹€æ…‹æ¢å¾©çš„å¯èƒ½æ€§
                    if (batteryLevel === 'low') {
                        possible.push('S0', 'C0'); // é›»æ± å¯èƒ½æ¢å¾©
                    }
                    break;
            }
            
            return [...new Set(possible)]; // å»é‡è¤‡
        }

        function startPress() {
            if (currentState === 'S3') {
                addDetailedLog('æŒ‰éµæ“ä½œ', 'ä½é›»é‡æ¨¡å¼ä¸‹æŒ‰éµè¢«ç¦ç”¨', 'error', 'ä¿è­·æ©Ÿåˆ¶ï¼šS3ç‹€æ…‹ä¸‹æ‰€æœ‰æŒ‰éµæ“ä½œç„¡æ•ˆ');
                return;
            }
            
            isPressed = true;
            pressStartTime = Date.now();
            
            const button = document.getElementById('powerButton');
            const indicator = document.getElementById('pressIndicator');
            const buttonText = document.getElementById('buttonText');
            
            button.style.background = '#2980b9';
            buttonText.textContent = 'æŒ‰ä½ä¸­...';
            
            addDetailedLog('æŒ‰éµæ“ä½œ', 'é–‹å§‹æŒ‰å£“é–‹é—œ', 'detailed', 'åµæ¸¬æŒ‰éµæŒ‰ä¸‹ï¼Œé–‹å§‹è¨ˆæ™‚åˆ¤æ–·çŸ­æŒ‰æˆ–é•·æŒ‰');
            
            // é–‹å§‹é€²åº¦æ¢å‹•ç•«
            pressTimer = setInterval(() => {
                if (!isPressed) return;
                
                const elapsed = Date.now() - pressStartTime;
                const progress = Math.min((elapsed / LONG_PRESS_DURATION) * 100, 100);
                indicator.style.width = progress + '%';
                
                if (progress >= 100) {
                    indicator.style.background = '#2ecc71'; // è®Šç¶ è¡¨ç¤ºé”åˆ°é•·æŒ‰
                }
            }, 50);
        }
        
        function endPress() {
            if (!isPressed || currentState === 'S3') return;
            
            const pressDuration = Date.now() - pressStartTime;
            isPressed = false;
            
            if (pressTimer) {
                clearInterval(pressTimer);
                pressTimer = null;
            }
            
            // é‡ç½®æŒ‰éˆ•å¤–è§€
            const button = document.getElementById('powerButton');
            const indicator = document.getElementById('pressIndicator');
            const buttonText = document.getElementById('buttonText');
            
            button.style.background = '#3498db';
            buttonText.textContent = 'æŒ‰ä½é–‹é—œ';
            indicator.style.width = '0%';
            indicator.style.background = '#f39c12';
            
            // åˆ¤æ–·æ˜¯çŸ­æŒ‰é‚„æ˜¯é•·æŒ‰
            if (pressDuration >= LONG_PRESS_DURATION) {
                addDetailedLog('æŒ‰éµæ“ä½œ', `é•·æŒ‰é–‹é—œ (æŒçºŒ${Math.round(pressDuration)}ms)`, 'detailed', 'é•·æŒ‰æ“ä½œï¼šé€šå¸¸ç”¨æ–¼é–‹æ©Ÿ/é—œæ©Ÿæˆ–é€²å…¥ä¸»è¦åŠŸèƒ½');
                longPress();
            } else if (pressDuration >= 100) { // è‡³å°‘100msæ‰ç®—æœ‰æ•ˆæŒ‰å£“
                addDetailedLog('æŒ‰éµæ“ä½œ', `çŸ­æŒ‰é–‹é—œ (æŒçºŒ${Math.round(pressDuration)}ms)`, 'detailed', 'çŸ­æŒ‰æ“ä½œï¼šé€šå¸¸ç”¨æ–¼åˆ‡æ›æ¨¡å¼æˆ–èª¿æ•´è¨­å®š');
                shortPress();
            }
        }

        function shortPress() {
            const oldState = currentState;
            
            switch(currentState) {
                case 'S1': 
                    addDetailedLog('ç‹€æ…‹è½‰æ›é‚è¼¯', 'S1çŸ­æŒ‰ï¼šé›»æ± æ¨¡å¼é¢¨æ‰‡åŠ é€Ÿ', 'auto-check', 'å¾ä½é€Ÿåˆ‡æ›åˆ°é«˜é€Ÿé‹è½‰');
                    setState('S2'); 
                    break;
                case 'S2': 
                    addDetailedLog('ç‹€æ…‹è½‰æ›é‚è¼¯', 'S2çŸ­æŒ‰ï¼šé›»æ± æ¨¡å¼é¢¨æ‰‡æ¸›é€Ÿ', 'auto-check', 'å¾é«˜é€Ÿåˆ‡æ›åˆ°ä½é€Ÿé‹è½‰');
                    setState('S1'); 
                    break;
                case 'C1': 
                    addDetailedLog('ç‹€æ…‹è½‰æ›é‚è¼¯', 'C1çŸ­æŒ‰ï¼šå……é›»æ¨¡å¼é¢¨æ‰‡åŠ é€Ÿ', 'auto-check', 'å……é›»åŒæ™‚å¾ä½é€Ÿåˆ‡æ›åˆ°é«˜é€Ÿé‹è½‰');
                    setState('C2'); 
                    break;
                case 'C2': 
                    addDetailedLog('ç‹€æ…‹è½‰æ›é‚è¼¯', 'C2çŸ­æŒ‰ï¼šå……é›»æ¨¡å¼é¢¨æ‰‡æ¸›é€Ÿ', 'auto-check', 'å……é›»åŒæ™‚å¾é«˜é€Ÿåˆ‡æ›åˆ°ä½é€Ÿé‹è½‰');
                    setState('C1'); 
                    break;
                case 'A1': 
                    addDetailedLog('ç‹€æ…‹è½‰æ›é‚è¼¯', 'A1çŸ­æŒ‰ï¼šæ»¿å……é›»æ¨¡å¼é¢¨æ‰‡åŠ é€Ÿ', 'auto-check', 'æ»¿å……é›»ä¾›é›»ä¸‹å¾ä½é€Ÿåˆ‡æ›åˆ°é«˜é€Ÿé‹è½‰');
                    setState('A2'); 
                    break;
                case 'A2': 
                    addDetailedLog('ç‹€æ…‹è½‰æ›é‚è¼¯', 'A2çŸ­æŒ‰ï¼šæ»¿å……é›»æ¨¡å¼é¢¨æ‰‡æ¸›é€Ÿ', 'auto-check', 'æ»¿å……é›»ä¾›é›»ä¸‹å¾é«˜é€Ÿåˆ‡æ›åˆ°ä½é€Ÿé‹è½‰');
                    setState('A1'); 
                    break;
                default: 
                    addDetailedLog('æŒ‰éµæ“ä½œ', `${oldState}ç‹€æ…‹ç„¡æ³•åŸ·è¡ŒçŸ­æŒ‰æ“ä½œ`, 'error', 'ç•¶å‰ç‹€æ…‹ä¸æ”¯æ´çŸ­æŒ‰åŠŸèƒ½');
            }
        }

        function longPress() {
            const oldState = currentState;
            
            switch(currentState) {
                case 'S0':
                    addDetailedLog('ç‹€æ…‹è½‰æ›é‚è¼¯', 'S0é•·æŒ‰ï¼šç³»çµ±é–‹æ©Ÿæª¢æŸ¥', 'auto-check', 'æª¢æŸ¥å……é›»å™¨å’Œé›»æ± ç‹€æ…‹ä»¥æ±ºå®šé€²å…¥æ¨¡å¼');
                    // æª¢æŸ¥å……é›»å™¨å’Œé›»æ± ç‹€æ…‹æ±ºå®šé€²å…¥å“ªå€‹ç‹€æ…‹
                    if (!chargerConnected) {
                        addDetailedLog('è‡ªå‹•æª¢æŸ¥', 'å……é›»å™¨æœªé€£æ¥ â†’ é€²å…¥é›»æ± æ¨¡å¼', 'auto-check', 'ä½¿ç”¨é›»æ± é›»æºå•Ÿå‹•ä½é€Ÿé¢¨æ‰‡');
                        setState('S1');
                    } else if (chargerConnected && batteryLevel !== 'full') {
                        addDetailedLog('è‡ªå‹•æª¢æŸ¥', 'å……é›»å™¨å·²é€£æ¥ + é›»æ± æœªå……æ»¿ â†’ é€²å…¥å……é›»æ¨¡å¼', 'auto-check', 'é‚Šå……é›»é‚Šå•Ÿå‹•ä½é€Ÿé¢¨æ‰‡');
                        setState('C1');
                    } else if (chargerConnected && batteryLevel === 'full') {
                        addDetailedLog('è‡ªå‹•æª¢æŸ¥', 'å……é›»å™¨å·²é€£æ¥ + é›»æ± å……æ»¿ â†’ é€²å…¥æ»¿å……é›»æ¨¡å¼', 'auto-check', 'ä½¿ç”¨æ»¿å……é›»æ¨¡å¼å•Ÿå‹•ä½é€Ÿé¢¨æ‰‡');
                        setState('A1');
                    }
                    break;
                case 'S1':
                case 'S2':
                    addDetailedLog('ç‹€æ…‹è½‰æ›é‚è¼¯', `${oldState}é•·æŒ‰ï¼šé›»æ± æ¨¡å¼é—œæ©Ÿ`, 'auto-check', 'æª¢æŸ¥æ˜¯å¦éœ€è¦è½‰å…¥å……é›»æ¨¡å¼è€Œéå®Œå…¨é—œæ©Ÿ');
                    // é›»æ± æ¨¡å¼é—œæ©Ÿ - æª¢æŸ¥å……é›»å™¨ç‹€æ…‹
                    if (chargerConnected) {
                        addDetailedLog('è‡ªå‹•æª¢æŸ¥', 'æª¢æ¸¬åˆ°å……é›»å™¨å·²é€£æ¥ï¼Œé€²å…¥å……é›»æ¨¡å¼è€Œéå®Œå…¨é—œæ©Ÿ', 'auto-check', 'ä¿æŒå……é›»ç‹€æ…‹ï¼Œé—œé–‰é¢¨æ‰‡');
                        setState('C0');
                    } else {
                        addDetailedLog('è‡ªå‹•æª¢æŸ¥', 'å……é›»å™¨æœªé€£æ¥ï¼Œå®Œå…¨é—œæ©Ÿ', 'auto-check', 'è¿”å›åˆå§‹ç‹€æ…‹');
                        setState('S0');
                    }
                    break;
                case 'C1':
                case 'C2':
                    addDetailedLog('ç‹€æ…‹è½‰æ›é‚è¼¯', `${oldState}é•·æŒ‰ï¼šå……é›»æ¨¡å¼é—œæ©Ÿ`, 'auto-check', 'é—œé–‰é¢¨æ‰‡ä½†ä¿æŒå……é›»ç‹€æ…‹');
                    // å……é›»æ¨¡å¼é—œæ©Ÿ - æª¢æŸ¥å……é›»å™¨ç‹€æ…‹
                    addDetailedLog('è‡ªå‹•æª¢æŸ¥', 'å……é›»æ¨¡å¼é—œæ©Ÿï¼Œç¹¼çºŒä¿æŒå……é›»ç‹€æ…‹', 'auto-check', 'é¢¨æ‰‡åœæ­¢ï¼Œå……é›»ç¹¼çºŒ');
                    setState('C0');
                    break;
                case 'A1':
                case 'A2':
                    addDetailedLog('ç‹€æ…‹è½‰æ›é‚è¼¯', `${oldState}é•·æŒ‰ï¼šæ»¿å……é›»æ¨¡å¼é—œæ©Ÿ`, 'auto-check', 'é—œé–‰é¢¨æ‰‡ä½†ä¿æŒé›»æºé€£æ¥');
                    // æ»¿å……é›»æ¨¡å¼é—œæ©Ÿ - æª¢æŸ¥å……é›»å™¨ç‹€æ…‹
                    addDetailedLog('è‡ªå‹•æª¢æŸ¥', 'æ»¿å……é›»æ¨¡å¼é—œæ©Ÿï¼Œä¿æŒé›»æºé€£æ¥ç‹€æ…‹', 'auto-check', 'é¢¨æ‰‡åœæ­¢ï¼Œé›»æºé€£æ¥ç¶­æŒ');
                    setState('A0');
                    break;
                case 'C0':
                    addDetailedLog('ç‹€æ…‹è½‰æ›é‚è¼¯', 'C0é•·æŒ‰ï¼šå……é›»ç‹€æ…‹ä¸‹å•Ÿå‹•é¢¨æ‰‡', 'auto-check', 'é–‹å§‹é‚Šå……é›»é‚Šé‹è½‰é¢¨æ‰‡');
                    setState('C1');
                    break;
                case 'A0':
                    addDetailedLog('ç‹€æ…‹è½‰æ›é‚è¼¯', 'A0é•·æŒ‰ï¼šæ»¿å……é›»ç‹€æ…‹ä¸‹å•Ÿå‹•é¢¨æ‰‡', 'auto-check', 'ä½¿ç”¨æ»¿å……é›»æ¨¡å¼é©…å‹•é¢¨æ‰‡');
                    setState('A1');
                    break;
                default:
                    addDetailedLog('æŒ‰éµæ“ä½œ', `${oldState}ç‹€æ…‹ç„¡æ³•åŸ·è¡Œé•·æŒ‰æ“ä½œ`, 'error', 'ç•¶å‰ç‹€æ…‹ä¸æ”¯æ´é•·æŒ‰åŠŸèƒ½');
            }
        }

        function toggleCharger() {
            const toggle = document.getElementById('chargerToggle');
            const toggleText = document.getElementById('chargerToggleText');
            const toggleSwitch = toggle.parentElement;
            
            if (chargerConnected) {
                // æ–·é–‹å……é›»å™¨
                chargerConnected = false;
                toggleSwitch.classList.remove('active');
                toggleText.textContent = 'æœªé€£æ¥';
                addDetailedLog('é›»æºç®¡ç†', 'ç§»é™¤å……é›»å™¨', 'detailed', 'ç‰©ç†æ–·é–‹å……é›»å™¨é€£æ¥');
                
                switch(currentState) {
                    case 'C0': 
                        addDetailedLog('ç‹€æ…‹è½‰æ›é‚è¼¯', 'C0ç‹€æ…‹ç§»é™¤å……é›»å™¨ â†’ è¿”å›S0', 'transition', 'å……é›»åˆå§‹ç‹€æ…‹å¤±å»é›»æºï¼Œå›åˆ°å®Œå…¨é—œé–‰ç‹€æ…‹');
                        setState('S0'); 
                        break;
                    case 'C1': 
                        addDetailedLog('ç‹€æ…‹è½‰æ›é‚è¼¯', 'C1ç‹€æ…‹ç§»é™¤å……é›»å™¨ â†’ è½‰å…¥S1', 'transition', 'å……é›»é‹è½‰ç‹€æ…‹è½‰ç‚ºé›»æ± é‹è½‰ï¼Œä¿æŒå°æ‡‰é¢¨æ‰‡é€Ÿåº¦');
                        setState('S1'); 
                        break;
                    case 'C2': 
                        addDetailedLog('ç‹€æ…‹è½‰æ›é‚è¼¯', 'C2ç‹€æ…‹ç§»é™¤å……é›»å™¨ â†’ è½‰å…¥S2', 'transition', 'å……é›»é‹è½‰ç‹€æ…‹è½‰ç‚ºé›»æ± é‹è½‰ï¼Œä¿æŒå°æ‡‰é¢¨æ‰‡é€Ÿåº¦');
                        setState('S2'); 
                        break;
                    case 'A0': 
                        addDetailedLog('ç‹€æ…‹è½‰æ›é‚è¼¯', 'A0ç‹€æ…‹ç§»é™¤å……é›»å™¨ â†’ è¿”å›S0', 'transition', 'æ»¿å……é›»ç‹€æ…‹å¤±å»é›»æºï¼Œå›åˆ°å®Œå…¨é—œé–‰ç‹€æ…‹');
                        setState('S0');
                        break;
                    case 'A1': 
                        addDetailedLog('ç‹€æ…‹è½‰æ›é‚è¼¯', 'A1ç‹€æ…‹ç§»é™¤å……é›»å™¨ â†’ è½‰å…¥S1', 'transition', 'æ»¿å……é›»é‹è½‰ç‹€æ…‹è½‰ç‚ºé›»æ± é‹è½‰ï¼Œä¿æŒå°æ‡‰é¢¨æ‰‡é€Ÿåº¦');
                        setState('S1'); 
                        break;
                    case 'A2': 
                        addDetailedLog('ç‹€æ…‹è½‰æ›é‚è¼¯', 'A2ç‹€æ…‹ç§»é™¤å……é›»å™¨ â†’ è½‰å…¥S2', 'transition', 'æ»¿å……é›»é‹è½‰ç‹€æ…‹è½‰ç‚ºé›»æ± é‹è½‰ï¼Œä¿æŒå°æ‡‰é¢¨æ‰‡é€Ÿåº¦');
                        setState('S2'); 
                        break;
                }
            } else {
                // é€£æ¥å……é›»å™¨
                chargerConnected = true;
                toggleSwitch.classList.add('active');
                toggleText.textContent = 'å·²é€£æ¥';
                addDetailedLog('é›»æºç®¡ç†', 'é€£æ¥å……é›»å™¨', 'detailed', 'ç‰©ç†é€£æ¥å……é›»å™¨ï¼Œé–‹å§‹ä¾›é›»');
                
                switch(currentState) {
                    case 'S0': 
                        addDetailedLog('ç‹€æ…‹è½‰æ›é‚è¼¯', 'S0ç‹€æ…‹é€£æ¥å……é›»å™¨ â†’ æª¢æŸ¥é›»æ± ç‹€æ…‹', 'auto-check', 'åˆå§‹ç‹€æ…‹æ¥å…¥é›»æºï¼Œéœ€åˆ¤æ–·é›»æ± å……é›»ç‹€æ³');
                        if (batteryLevel === 'full') {
                            addDetailedLog('è‡ªå‹•æª¢æŸ¥', 'é›»æ± å·²å……æ»¿ â†’ æº–å‚™é€²å…¥æ»¿å……é›»æ¨¡å¼', 'auto-check', 'é›»æ± æ»¿é›»æ™‚éœ€ç¶“éå……é›»æ¨¡å¼å†å‡ç´šåˆ°æ»¿å……é›»æ¨¡å¼');
                            
                            // å…ˆé€²å…¥C0ç‹€æ…‹
                            setTimeout(() => {
                                addDetailedLog('ç‹€æ…‹è½‰æ›', 'S0 â†’ C0', 'transition', 'ä¸­é–“ç‹€æ…‹ï¼šå…ˆé€²å…¥å……é›»åˆå§‹ç‹€æ…‹');
                                currentState = 'C0';
                                updateDisplay();
                                
                                // å†å‡ç´šåˆ°A0ç‹€æ…‹
                                setTimeout(() => {
                                    addDetailedLog('ç‹€æ…‹è½‰æ›', 'C0 â†’ A0', 'transition', 'è‡ªå‹•å‡ç´šï¼šé€²å…¥æ»¿å……é›»åˆå§‹ç‹€æ…‹');
                                    currentState = 'A0';
                                    updateDisplay();
                                }, 700);
                            }, 400);
                        } else {
                            addDetailedLog('è‡ªå‹•æª¢æŸ¥', 'é›»æ± æœªå……æ»¿ â†’ é€²å…¥C0ç‹€æ…‹', 'auto-check', 'é›»æ± æœªæ»¿æ™‚é€²å…¥å……é›»æ¨¡å¼');
                            setTimeout(() => {
                                addDetailedLog('ç‹€æ…‹è½‰æ›', 'S0 â†’ C0', 'transition', 'é€²å…¥å……é›»åˆå§‹ç‹€æ…‹');
                                currentState = 'C0';
                                updateDisplay();
                            }, 400);
                        }
                        break;
                    case 'S1': 
                        addDetailedLog('ç‹€æ…‹è½‰æ›é‚è¼¯', 'S1ç‹€æ…‹é€£æ¥å……é›»å™¨ â†’ è½‰å…¥C1', 'transition', 'é›»æ± é‹è½‰ç‹€æ…‹æ¥å…¥é›»æºï¼Œè½‰ç‚ºå……é›»é‹è½‰ï¼Œä¿æŒå°æ‡‰é¢¨æ‰‡é€Ÿåº¦');
                        setState('C1'); 
                        break;
                    case 'S2': 
                        addDetailedLog('ç‹€æ…‹è½‰æ›é‚è¼¯', 'S2ç‹€æ…‹é€£æ¥å……é›»å™¨ â†’ è½‰å…¥C2', 'transition', 'é›»æ± é‹è½‰ç‹€æ…‹æ¥å…¥é›»æºï¼Œè½‰ç‚ºå……é›»é‹è½‰ï¼Œä¿æŒå°æ‡‰é¢¨æ‰‡é€Ÿåº¦');
                        setState('C2'); 
                        break;
                }
            }
            
            updateDisplay();
        }

        function setBatteryStatus(status) {
            const oldStatus = batteryLevel;
            batteryLevel = status;
            
            // æ›´æ–°æ——æ¨™é¡¯ç¤º
            document.querySelectorAll('.flag-btn').forEach(btn => btn.classList.remove('active', 'low', 'full'));
            const activeFlag = document.getElementById(`battery${status.charAt(0).toUpperCase() + status.slice(1)}Flag`);
            activeFlag.classList.add('active');
            if (status === 'low') activeFlag.classList.add('low');
            if (status === 'full') activeFlag.classList.add('full');
            
            const statusText = status === 'normal' ? 'æ­£å¸¸' : status === 'low' ? 'ä½é›»é‡' : 'å·²å……æ»¿';
            addDetailedLog('é›»æ± ç®¡ç†', `é›»æ± ç‹€æ…‹è®Šæ›´ï¼š${statusText}`, 'detailed', `é›»æ± ç‹€æ…‹å¾${oldStatus === 'normal' ? 'æ­£å¸¸' : oldStatus === 'low' ? 'ä½é›»é‡' : 'å·²å……æ»¿'}è®Šæ›´ç‚º${statusText}`);
            
            // æ ¹æ“šé›»æ± ç‹€æ…‹è®Šæ›´è™•ç†ç‹€æ…‹è½‰æ›
            if (status === 'low' && ['S1', 'S2', 'C1', 'C2', 'A1', 'A2'].includes(currentState)) {
                addDetailedLog('å®‰å…¨ä¿è­·', 'æª¢æ¸¬åˆ°é›»æ± ä½é›»é‡ï¼Œæº–å‚™é€²å…¥ä¿è­·æ¨¡å¼', 'error', 'ä½é›»é‡ä¿è­·æ©Ÿåˆ¶ï¼šå³å°‡å¼·åˆ¶åœæ­¢é¢¨æ‰‡é‹è½‰');
                
                // å»¶é²é€²å…¥S3ç‹€æ…‹ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°ä¿è­·è§¸ç™¼éç¨‹
                setTimeout(() => {
                    const oldState = currentState;
                    currentState = 'S3';
                    addDetailedLog('ç‹€æ…‹è½‰æ›', `${states[oldState].name} â†’ ${states['S3'].name}`, 'transition', 'å¼·åˆ¶é€²å…¥ä½é›»é‡ä¿è­·ç‹€æ…‹');
                    showTransitionEffect('S3', 1000);
                    startCountdown();
                    updateDisplay();
                }, 500);
            } else if (status === 'full' && chargerConnected) {
                // é›»æ± å……æ»¿æ™‚çš„ç‹€æ…‹å‡ç´š
                const upgradeMap = { 'C0': 'A0', 'C1': 'A1', 'C2': 'A2' };
                if (upgradeMap[currentState]) {
                    addDetailedLog('è‡ªå‹•å‡ç´š', `é›»æ± å……æ»¿ â†’ æº–å‚™å‡ç´šåˆ°${upgradeMap[currentState]}ç‹€æ…‹`, 'auto-check', 'å……é›»å®Œæˆï¼Œç³»çµ±å°‡è‡ªå‹•åˆ‡æ›åˆ°æ»¿å……é›»æ¨¡å¼ä»¥æå‡æ•ˆèƒ½');
                    
                    // å»¶é²å‡ç´šï¼Œè®“ç”¨æˆ¶çœ‹åˆ°éç¨‹
                    setTimeout(() => {
                        const oldState = currentState;
                        const newState = upgradeMap[oldState];
                        addDetailedLog('ç‹€æ…‹è½‰æ›', `${states[oldState].name} â†’ ${states[newState].name}`, 'transition', 'è‡ªå‹•å‡ç´šï¼šå¾å……é›»æ¨¡å¼å‡ç´šåˆ°æ»¿å……é›»æ¨¡å¼');
                        currentState = newState;
                        updateDisplay();
                    }, 600);
                } else if (currentState === 'S0') {
                    addDetailedLog('è‡ªå‹•å‡ç´š', 'é›»æ± å……æ»¿ + å……é›»å™¨é€£æ¥ â†’ æº–å‚™é€²å…¥A0ç‹€æ…‹', 'auto-check', 'é›»æ± æ»¿é›»ä¸”æœ‰å¤–éƒ¨é›»æºï¼Œå°‡é€²å…¥æ»¿å……é›»æ¨¡å¼');
                    
                    // å…ˆé€²å…¥C0ï¼Œå†å‡ç´šåˆ°A0
                    setTimeout(() => {
                        addDetailedLog('ç‹€æ…‹è½‰æ›', 'S0 â†’ C0', 'transition', 'ä¸­é–“ç‹€æ…‹ï¼šå…ˆé€²å…¥å……é›»åˆå§‹ç‹€æ…‹');
                        currentState = 'C0';
                        updateDisplay();
                        
                        setTimeout(() => {
                            addDetailedLog('ç‹€æ…‹è½‰æ›', 'C0 â†’ A0', 'transition', 'è‡ªå‹•å‡ç´šï¼šé€²å…¥æ»¿å……é›»åˆå§‹ç‹€æ…‹');
                            currentState = 'A0';
                            updateDisplay();
                        }, 600);
                    }, 400);
                }
            } else if (status === 'normal' && chargerConnected && ['A0', 'A1', 'A2'].includes(currentState)) {
                // Aç‹€æ…‹é›»æ± å¾å……æ»¿è®Šç‚ºæ­£å¸¸ï¼Œé™ç´šåˆ°Cç‹€æ…‹
                const downgradeMap = { 'A0': 'C0', 'A1': 'C1', 'A2': 'C2' };
                addDetailedLog('è‡ªå‹•é™ç´š', `é›»æ± ä¸å†å……æ»¿ â†’ æº–å‚™é™ç´šåˆ°${downgradeMap[currentState]}ç‹€æ…‹`, 'auto-check', 'é›»æ± é›»é‡ä¸‹é™ï¼Œå°‡å¾æ»¿å……é›»æ¨¡å¼é™ç´šè‡³å……é›»æ¨¡å¼');
                
                // å»¶é²é™ç´šï¼Œè®“ç”¨æˆ¶çœ‹åˆ°éç¨‹
                setTimeout(() => {
                    const oldState = currentState;
                    const newState = downgradeMap[oldState];
                    addDetailedLog('ç‹€æ…‹è½‰æ›', `${states[oldState].name} â†’ ${states[newState].name}`, 'transition', 'è‡ªå‹•é™ç´šï¼šå¾æ»¿å……é›»æ¨¡å¼é™ç´šåˆ°å……é›»æ¨¡å¼');
                    currentState = newState;
                    updateDisplay();
                }, 600);
            } else if (oldStatus === 'low' && status !== 'low' && currentState === 'S3') {
                // å¾ä½é›»é‡æ¢å¾©
                addDetailedLog('ç‹€æ…‹æ¢å¾©', 'é›»æ± ç‹€æ…‹æ¢å¾©ï¼Œæº–å‚™é€€å‡ºä¿è­·æ¨¡å¼', 'transition', 'é›»æ± é›»é‡æ¢å¾©æ­£å¸¸ï¼Œå³å°‡è§£é™¤ä½é›»é‡ä¿è­·');
                if (countdownTimer) {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                }
                
                setTimeout(() => {
                    if (chargerConnected) {
                        addDetailedLog('ç‹€æ…‹è½‰æ›', 'S3 â†’ C0', 'transition', 'é›»é‡æ¢å¾©ä¸”æœ‰å¤–éƒ¨é›»æºï¼Œé€²å…¥å……é›»æ¨¡å¼');
                        showTransitionEffect('C0', 600);
                        currentState = 'C0';
                        updateDisplay();
                    } else {
                        addDetailedLog('ç‹€æ…‹è½‰æ›', 'S3 â†’ S0', 'transition', 'é›»é‡æ¢å¾©ä½†ç„¡å¤–éƒ¨é›»æºï¼Œå›åˆ°åˆå§‹ç‹€æ…‹');
                        showTransitionEffect('S0', 600);
                        currentState = 'S0';
                        updateDisplay();
                    }
                }, 600);
            }
            
            updateDisplay();
        }

        function resetSystem() {
            currentState = 'S0';
            chargerConnected = false;
            batteryLevel = 'normal';
            
            // æ¸…é™¤æ‰€æœ‰è¨ˆæ™‚å™¨
            if (lowVoltageTimer) {
                clearTimeout(lowVoltageTimer);
                lowVoltageTimer = null;
            }
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            if (pressTimer) {
                clearInterval(pressTimer);
                pressTimer = null;
            }
            
            // é‡ç½®æŒ‰éµç‹€æ…‹
            isPressed = false;
            const button = document.getElementById('powerButton');
            const indicator = document.getElementById('pressIndicator');
            const buttonText = document.getElementById('buttonText');
            button.style.background = '#3498db';
            buttonText.textContent = 'æŒ‰ä½é–‹é—œ';
            indicator.style.width = '0%';
            indicator.style.background = '#f39c12';
            
            // é‡ç½®UIç‹€æ…‹
            const toggleSwitch = document.getElementById('chargerToggle').parentElement;
            toggleSwitch.classList.remove('active');
            document.getElementById('chargerToggleText').textContent = 'æœªé€£æ¥';
            
            // é‡ç½®é›»æ± æ——æ¨™
            document.querySelectorAll('.flag-btn').forEach(btn => btn.classList.remove('active', 'low', 'full'));
            document.getElementById('batteryNormalFlag').classList.add('active');
            
            addDetailedLog('ç³»çµ±æ“ä½œ', 'ç³»çµ±é‡ç½®è‡³åˆå§‹ç‹€æ…‹', 'detailed', 'æ‰€æœ‰è¨­å®šå›åˆ°é è¨­å€¼ï¼Œæ¸…é™¤æ‰€æœ‰ç‹€æ…‹å’Œè¨ˆæ™‚å™¨');
            updateDisplay();
        }

        function setState(newState) {
            // æ¸…é™¤ç¾æœ‰çš„è¨ˆæ™‚å™¨
            if (lowVoltageTimer) {
                clearTimeout(lowVoltageTimer);
                lowVoltageTimer = null;
            }
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            
            const oldState = currentState;
            
            // å¦‚æœè¦é€²å…¥é‹è½‰ç‹€æ…‹ï¼Œå…ˆæª¢æŸ¥é›»æ± æ˜¯å¦ä½é›»é‡
            if (['S1', 'S2', 'C1', 'C2', 'A1', 'A2'].includes(newState) && batteryLevel === 'low') {
                addDetailedLog('å®‰å…¨ä¿è­·', 'æª¢æ¸¬åˆ°é›»æ± ä½é›»é‡ï¼Œç„¡æ³•é€²å…¥é‹è½‰ç‹€æ…‹', 'error', 'ä½é›»é‡å®‰å…¨æ©Ÿåˆ¶ï¼šé˜»æ­¢é€²å…¥é‹è½‰ç‹€æ…‹');
                
                // å»¶é²é€²å…¥S3ä¿è­·ç‹€æ…‹
                setTimeout(() => {
                    newState = 'S3';
                    currentState = newState;
                    addDetailedLog('ç‹€æ…‹è½‰æ›', `${oldState} â†’ ${states[newState].name}`, 'transition', 'å¼·åˆ¶é€²å…¥ä½é›»é‡ä¿è­·ç‹€æ…‹');
                    showTransitionEffect('S3', 1000);
                    startCountdown();
                    updateDisplay();
                }, 400);
                return;
            }
            // ç‹€æ…‹è½‰æ›çš„è‡ªå‹•æª¢æŸ¥æ©Ÿåˆ¶
            else if (newState === 'S0' && chargerConnected) {
                addDetailedLog('è‡ªå‹•æª¢æŸ¥', 'å˜—è©¦é€²å…¥S0 â†’ æª¢æŸ¥å……é›»å™¨ç‹€æ…‹ â†’ å·²é€£æ¥', 'auto-check', 'S0é€²å…¥é‚è¼¯ï¼šç™¼ç¾å¤–éƒ¨é›»æºï¼Œè‡ªå‹•è½‰å‘å……é›»ç›¸é—œç‹€æ…‹');
                
                // å…ˆè½‰åˆ°C0ç‹€æ…‹ä¸¦é¡¯ç¤º
                currentState = 'C0';
                addDetailedLog('ç‹€æ…‹è½‰æ›', `${oldState} â†’ ${states['C0'].name}`, 'transition', 'ä¸­é–“ç‹€æ…‹ï¼šå…ˆé€²å…¥å……é›»åˆå§‹ç‹€æ…‹');
                showTransitionEffect('C0', 600);
                updateDisplay();
                
                // å¦‚æœé›»æ± å·²å……æ»¿ï¼Œå»¶é²è½‰å…¥A0ä¸¦é¡¯ç¤ºéç¨‹
                if (batteryLevel === 'full') {
                    setTimeout(() => {
                        addDetailedLog('è‡ªå‹•æª¢æŸ¥', 'æª¢æŸ¥é›»æ± ç‹€æ…‹ â†’ å·²å……æ»¿ â†’ è‡ªå‹•è½‰å…¥A0ç‹€æ…‹', 'auto-check', 'é›»æ± æ»¿é›»ä¸”æœ‰å¤–éƒ¨é›»æºï¼Œå‡ç´šè‡³æ»¿å……é›»æ¨¡å¼');
                        currentState = 'A0';
                        addDetailedLog('ç‹€æ…‹è½‰æ›', `C0 â†’ ${states['A0'].name}`, 'transition', 'è‡ªå‹•å‡ç´šï¼šå¾å……é›»æ¨¡å¼å‡ç´šåˆ°æ»¿å……é›»æ¨¡å¼');
                        showTransitionEffect('A0', 600);
                        updateDisplay();
                    }, 800); // å»¶é²800msè®“ç”¨æˆ¶çœ‹åˆ°C0ç‹€æ…‹
                }
                return;
            }
            // é€²å…¥å……é›»ç‹€æ…‹æ™‚æª¢æŸ¥é›»æ± ç‹€æ…‹
            else if (['C0', 'C1', 'C2'].includes(newState) && batteryLevel === 'full') {
                const aStateMap = { 'C0': 'A0', 'C1': 'A1', 'C2': 'A2' };
                const originalState = newState;
                const finalState = aStateMap[newState];
                
                // å…ˆé¡¯ç¤ºåŸå§‹ç‹€æ…‹
                currentState = originalState;
                addDetailedLog('ç‹€æ…‹è½‰æ›', `${oldState} â†’ ${states[originalState].name}`, 'transition', 'ä¸­é–“ç‹€æ…‹ï¼šå…ˆé€²å…¥å……é›»æ¨¡å¼');
                showTransitionEffect(originalState, 600);
                updateDisplay();
                
                // å»¶é²å¾Œè‡ªå‹•å‡ç´šåˆ°Aç‹€æ…‹
                setTimeout(() => {
                    addDetailedLog('è‡ªå‹•å‡ç´š', `æª¢æŸ¥é›»æ± ç‹€æ…‹ â†’ å·²å……æ»¿ â†’ è‡ªå‹•å‡ç´š${originalState}åˆ°${finalState}ç‹€æ…‹`, 'auto-check', 'é›»æ± å·²æ»¿ï¼Œè‡ªå‹•å¾å……é›»æ¨¡å¼å‡ç´šåˆ°æ»¿å……é›»æ¨¡å¼');
                    currentState = finalState;
                    addDetailedLog('ç‹€æ…‹è½‰æ›', `${originalState} â†’ ${states[finalState].name}`, 'transition', 'è‡ªå‹•å‡ç´šå®Œæˆ');
                    showTransitionEffect(finalState, 600);
                    updateDisplay();
                }, 800); // å»¶é²800msè®“ç”¨æˆ¶çœ‹åˆ°ä¸­é–“ç‹€æ…‹
                return;
            }
            
            currentState = newState;
            addDetailedLog('ç‹€æ…‹è½‰æ›', `${oldState} â†’ ${states[newState].name}`, 'transition', `ç‹€æ…‹è½‰æ›æˆåŠŸï¼š${states[oldState] ? states[oldState].name : oldState} è½‰æ›ç‚º ${states[newState].name}`);
            
            // å¦‚æœé€²å…¥S3ç‹€æ…‹ï¼Œéœ€è¦å•Ÿå‹•å€’æ•¸
            if (newState === 'S3') {
                startCountdown();
            }
            
            updateDisplay();
        }
        
        function startCountdown() {
            countdownSeconds = 10;
            updateCountdownDisplay();
            addDetailedLog('ä¿è­·æ©Ÿåˆ¶', 'å•Ÿå‹•10ç§’è‡ªå‹•è¿”å›å€’æ•¸', 'auto-check', 'S3ç‹€æ…‹å®‰å…¨æ©Ÿåˆ¶ï¼š10ç§’å¾Œè‡ªå‹•é€€å‡ºä¿è­·æ¨¡å¼');
            
            countdownTimer = setInterval(() => {
                countdownSeconds--;
                updateCountdownDisplay();
                
                if (countdownSeconds <= 0) {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                    addDetailedLog('ä¿è­·æ©Ÿåˆ¶', 'ä½é›»é‡ç‹€æ…‹10ç§’è¶…æ™‚ï¼Œè‡ªå‹•è¿”å›', 'auto-check', 'å€’æ•¸çµæŸï¼Œæ ¹æ“šå……é›»å™¨ç‹€æ…‹æ±ºå®šè¿”å›ä½ç½®');
                    
                    // æ ¹æ“šå……é›»å™¨ç‹€æ…‹æ±ºå®šè¿”å›ä½ç½®
                    if (chargerConnected) {
                        addDetailedLog('è‡ªå‹•æª¢æŸ¥', 'å……é›»å™¨å·²é€£æ¥ â†’ è¿”å›C0ç‹€æ…‹', 'auto-check', 'å¤–éƒ¨é›»æºå­˜åœ¨ï¼Œé€²å…¥å……é›»åˆå§‹ç‹€æ…‹');
                        setState('C0');
                    } else {
                        addDetailedLog('è‡ªå‹•æª¢æŸ¥', 'å……é›»å™¨æœªé€£æ¥ â†’ è¿”å›S0ç‹€æ…‹', 'auto-check', 'ç„¡å¤–éƒ¨é›»æºï¼Œå›åˆ°å®Œå…¨é—œé–‰ç‹€æ…‹');
                        setState('S0');
                    }
                }
            }, 1000);
        }
        
        function updateCountdownDisplay() {
            const countdownDisplay = document.getElementById('countdownDisplay');
            const countdownNumber = document.getElementById('countdownNumber');
            const countdownProgress = document.getElementById('countdownProgress');
            
            if (currentState === 'S3') {
                countdownDisplay.style.display = 'block';
                countdownNumber.textContent = countdownSeconds;
                const progressPercent = ((10 - countdownSeconds) / 10) * 100;
                countdownProgress.style.width = progressPercent + '%';
            } else {
                countdownDisplay.style.display = 'none';
            }
        }

        function updateDisplay() {
            const state = states[currentState];
            
            // æ›´æ–°ç‡ˆå…‰
            const greenLight = document.getElementById('greenLight');
            const redLight = document.getElementById('redLight');
            
            greenLight.className = 'light green' + (state.green ? ' on' : ' off');
            redLight.className = 'light red' + (state.red === true ? ' on' : state.red === 'blink' ? ' on blink' : ' off');
            
            // æ›´æ–°é¢¨æ‰‡
            const fanIcon = document.getElementById('fanIcon');
            const fanStatus = document.getElementById('fanStatus');
            
            fanIcon.className = 'fan-icon' + (state.fan === 1 ? ' speed1' : state.fan === 2 ? ' speed2' : '');
            
            switch(state.fan) {
                case 0: fanStatus.textContent = 'é¢¨æ‰‡é—œé–‰'; break;
                case 1: fanStatus.textContent = 'é¢¨æ‰‡ä½é€Ÿé‹è½‰'; break;
                case 2: fanStatus.textContent = 'é¢¨æ‰‡é«˜é€Ÿé‹è½‰'; break;
            }
            
            // æ›´æ–°ç‹€æ…‹è³‡è¨Š
            document.getElementById('currentState').textContent = state.name;
            document.getElementById('stateDescription').textContent = state.desc;
            document.getElementById('availableActions').textContent = state.actions;
            
            // æ›´æ–°å€’æ•¸é¡¯ç¤º
            updateCountdownDisplay();
            
            // æ›´æ–°ç‹€æ…‹é¢æ¿
            document.getElementById('statusState').textContent = currentState;
            document.getElementById('batteryStatus').textContent = 
                batteryLevel === 'low' ? 'ä½é›»é‡' : batteryLevel === 'full' ? 'å·²å……æ»¿' : 'æ­£å¸¸';
            document.getElementById('chargerStatus').textContent = chargerConnected ? 'å·²é€£æ¥' : 'æœªé€£æ¥';
            document.getElementById('fanSpeed').textContent = 
                state.fan === 0 ? 'é—œé–‰' : state.fan === 1 ? 'ä½é€Ÿ' : 'é«˜é€Ÿ';
            document.getElementById('buttonStatus').textContent = currentState === 'S3' ? 'ç¦ç”¨' : 'å•Ÿç”¨';
            
            // æ›´æ–°ç‹€æ…‹è½‰ç§»åœ–
            updateStateMap();
        }

        function addDetailedLog(category, message, type = 'detailed', reason = '') {
            const logContainer = document.getElementById('logContainer');
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                fractionalSecondDigits: 1
            });
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            
            let categoryIcon = '';
            switch(category) {
                case 'æŒ‰éµæ“ä½œ': categoryIcon = 'ğŸ¯'; break;
                case 'ç‹€æ…‹è½‰æ›é‚è¼¯': categoryIcon = 'ğŸ”„'; break;
                case 'è‡ªå‹•æª¢æŸ¥': categoryIcon = 'ğŸ”'; break;
                case 'ç‹€æ…‹è½‰æ›': categoryIcon = 'â¡ï¸'; break;
                case 'é›»æºç®¡ç†': categoryIcon = 'ğŸ”Œ'; break;
                case 'é›»æ± ç®¡ç†': categoryIcon = 'ğŸ”‹'; break;
                case 'å®‰å…¨ä¿è­·': categoryIcon = 'ğŸ›¡ï¸'; break;
                case 'ä¿è­·æ©Ÿåˆ¶': categoryIcon = 'â°'; break;
                case 'è‡ªå‹•å‡ç´š': categoryIcon = 'â¬†ï¸'; break;
                case 'è‡ªå‹•é™ç´š': categoryIcon = 'â¬‡ï¸'; break;
                case 'ç‹€æ…‹æ¢å¾©': categoryIcon = 'âœ…'; break;
                case 'ç³»çµ±æ“ä½œ': categoryIcon = 'âš™ï¸'; break;
                default: categoryIcon = 'ğŸ“'; break;
            }
            
            logEntry.innerHTML = `
                <span class="log-time">[${timeStr}]</span> 
                ${categoryIcon} <strong>${category}:</strong> ${message}
                ${reason ? `<div class="log-reason">ğŸ’¡ ${reason}</div>` : ''}
            `;
            
            // æ·»åŠ æ—¥èªŒæ¢ç›®
            logContainer.appendChild(logEntry);
            
            // é™åˆ¶æ—¥èªŒæ¢ç›®æ•¸é‡ï¼ˆä¿ç•™æœ€æ–°30æ¢ï¼‰
            const entries = logContainer.querySelectorAll('.log-entry');
            if (entries.length > 30) {
                entries[0].remove();
            }
            
            // ç²å–æ—¥èªŒé¢æ¿å…ƒç´ ï¼ˆåŒ…å«æ»¾å‹•æ¢çš„çˆ¶å®¹å™¨ï¼‰
            const logPanel = document.querySelector('.log-panel');
            
            // å¼·åˆ¶æ»¾å‹•åˆ°æœ€åº•éƒ¨ - å¤šé‡ä¿éšœ
            function scrollToBottom() {
                if (logPanel) {
                    logPanel.scrollTop = logPanel.scrollHeight;
                }
                if (logContainer) {
                    logContainer.scrollTop = logContainer.scrollHeight;
                }
            }
            
            // ç«‹å³æ»¾å‹•
            scrollToBottom();
            
            // å»¶é²æ»¾å‹•ï¼ˆç¢ºä¿DOMå®Œå…¨æ›´æ–°ï¼‰
            setTimeout(scrollToBottom, 50);
            setTimeout(scrollToBottom, 100);
            
            // æ·»åŠ æ·¡å…¥å‹•ç•«æ•ˆæœ
            logEntry.style.opacity = '0';
            logEntry.style.transform = 'translateY(10px)';
            
            requestAnimationFrame(() => {
                logEntry.style.transition = 'all 0.3s ease';
                logEntry.style.opacity = '1';
                logEntry.style.transform = 'translateY(0)';
                
                // å‹•ç•«å®Œæˆå¾Œå†æ¬¡ç¢ºä¿æ»¾å‹•åˆ°åº•éƒ¨
                setTimeout(scrollToBottom, 300);
            });
        }
    </script>
</body>
</html>