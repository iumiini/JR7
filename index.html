<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JR7æ ¡æ­£æ²»å…·æ“ä½œæµç¨‹</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #e1f5fe;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .title {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .controls {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .controls h4 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }
        
        .control-group {
            margin: 15px 0;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        .mode-toggle {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            margin: 0 5px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .mode-toggle.inactive {
            background: #6c757d;
        }
        
        .mode-toggle:hover {
            transform: scale(1.05);
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .main-content {
            display: flex;
            gap: 20px;
        }
        
        .flow-diagram {
            flex: 2;
            min-width: 600px;
        }
        
        .flow-steps {
            flex: 1;
            min-width: 500px;
        }
        
        .diagram-area {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            position: relative;
            height: 500px;
        }
        
        .pc-side, .device-side {
            width: 280px;
            background: #e6f3ff;
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 20px;
            position: relative;
            height: 450px;
        }
        
        .device-side {
            background: #fff2e6;
            border-color: #ff7f00;
        }
        
        .device-controls {
            margin: 15px 0;
            text-align: center;
        }
        
        .device-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            min-width: 80px;
            animation: breathe 2s ease-in-out infinite;
        }
        
        @keyframes breathe {
            0%, 100% { 
                box-shadow: 0 0 5px rgba(40, 167, 69, 0.5);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 20px rgba(40, 167, 69, 0.8);
                transform: scale(1.02);
            }
        }
        
        .device-button:hover {
            background: #218838;
            transform: scale(1.05);
        }
        
        .device-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            animation: none;
        }
        
        .waiting-blink {
            animation: slowBlink 2s ease-in-out infinite;
        }
        
        @keyframes slowBlink {
            0%, 100% { 
                opacity: 1;
                background: #fff3cd;
                border-color: #ffeaa7;
            }
            50% { 
                opacity: 0.6;
                background: #fff8e1;
                border-color: #ffecb3;
            }
        }
        
        .external-controls {
            position: absolute;
            bottom: -80px;
            left: 0;
            right: 0;
            text-align: center;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
        }
        
        .status-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            margin: 2px;
            transition: all 0.3s;
        }
        
        .status-button.inactive {
            background: #dc3545;
        }
        
        .connection {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            z-index: 10;
        }
        
        .usb-port {
            background: #6c757d;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 0 10px;
            font-weight: bold;
        }
        
        .arrow {
            font-size: 24px;
            color: #007bff;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .data-flow {
            position: absolute;
            top: 70%;
            background: #ff6b6b;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            opacity: 0;
            transition: all 0.5s;
            white-space: nowrap;
        }
        
        .data-flow.device-to-pc {
            left: 80%;
            animation: dataToPC 2s ease-in-out;
        }
        
        .data-flow.pc-to-device {
            left: 20%;
            animation: dataToDEVICE 2s ease-in-out;
        }
        
        .data-flow.notify-pc {
            left: 80%;
            animation: dataToPC 2s ease-in-out;
        }
        
        @keyframes dataToPC {
            0% { 
                left: 80%; 
                opacity: 1;
            }
            100% { 
                left: 20%; 
                opacity: 1;
            }
        }
        
        @keyframes dataToDEVICE {
            0% { left: 20%; opacity: 1; }
            100% { left: 80%; opacity: 1; }
        }
        
        .status-display {
            text-align: center;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
            font-weight: bold;
            min-height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .flow-steps {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            height: fit-content;
        }
        
        .flow-steps h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            text-align: center;
        }
        
        .steps-container {
            display: flex;
            gap: 20px;
        }
        
        .steps-column {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .column-title {
            text-align: center;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .step-item {
            padding: 10px 12px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 4px solid #e9ecef;
            background: #f8f9fa;
            transition: all 0.3s;
            font-size: 13px;
            position: relative;
        }
        
        .step-item.active {
            background: #28a745;
            color: white;
            border-left-color: #155724;
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
            animation: activeStep 0.5s ease-in-out;
        }
        
        .step-item.completed {
            background: #6c757d;
            color: white;
            border-left-color: #495057;
        }
        
        .step-item.pending {
            background: #f8f9fa;
            color: #6c757d;
            border-left-color: #e9ecef;
        }
        
        .step-arrow {
            text-align: center;
            font-size: 16px;
            color: #007bff;
            margin: 8px 0;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-3px); }
            60% { transform: translateY(-2px); }
        }
        
        @keyframes activeStep {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1.02); }
        }
        
        .highlight {
            animation: highlight 1s ease-in-out;
        }
        
        @keyframes highlight {
            0%, 100% { 
                border-color: inherit;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
            50% { 
                border-color: #ffc107;
                box-shadow: 0 8px 16px rgba(255, 193, 7, 0.4);
                transform: scale(1.02);
            }
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }
        
        .step-number {
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .step-item.active .step-number {
            background: #155724;
        }
        
        .step-item.completed .step-number {
            background: #495057;
        }
        
        .step-item.pending .step-number {
            background: #adb5bd;
        }
        
        .current-info {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            color: #155724;
        }
        
        .current-info strong {
            font-size: 16px;
        }
        
        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .prerequisite-check {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">JR7æ ¡æ­£æ²»å…·æ“ä½œæµç¨‹å‹•ç•«<br><small style="font-size: 18px; color: #666;">JR7æ ¡æ­£æ²»å…·æ“ä½œãƒ•ãƒ­ãƒ¼å‹•ç”»</small></h1>
        
        <div class="controls">
            <h4>ğŸ® æ¼”ç¤ºè¨­å®š<br><small style="font-size: 12px; color: #666;">ãƒ‡ãƒ¢è¨­å®š</small></h4>
            
            <div class="control-group">
                <label>æ¼”ç¤ºæ¨¡å¼ / ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰</label>
                <button class="mode-toggle" onclick="setAutoMode()" id="autoModeBtn">è‡ªå‹•æ¼”ç¤ºæ¨¡å¼<br><small>è‡ªå‹•ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰</small></button>
                <button class="mode-toggle inactive" onclick="setManualMode()" id="manualModeBtn">æ‰‹å‹•æ¼”ç¤ºæ¨¡å¼<br><small>æ‰‹å‹•ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰</small></button>
            </div>
            
            <div class="control-group">
                <label>æ¼”ç¤ºæƒ…å¢ƒ / ãƒ‡ãƒ¢ã‚·ãƒŠãƒªã‚ª</label>
                <button class="mode-toggle" onclick="setNormalTest()" id="normalTestBtn">æ¸¬è©¦æ­£å¸¸<br><small>ãƒ†ã‚¹ãƒˆæ­£å¸¸</small></button>
                <button class="mode-toggle inactive" onclick="setAbnormalTest()" id="abnormalTestBtn">æ¸¬è©¦ç•°å¸¸<br><small>ãƒ†ã‚¹ãƒˆç•°å¸¸</small></button>
            </div>
            
            <div class="control-group">
                <label>æµç¨‹æ§åˆ¶ / ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡</label>
                <button onclick="nextStep()" id="nextStepBtn" style="display: none;">ä¸‹ä¸€æ­¥<br><small>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</small></button>
                <button onclick="stopAnimation()">åœæ­¢<br><small>åœæ­¢</small></button>
                <button onclick="reset()">é‡ç½®<br><small>ãƒªã‚»ãƒƒãƒˆ</small></button>
            </div>
            
            <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 14px; color: #666;">
                <strong>ä½¿ç”¨èªªæ˜ï¼š</strong><span id="modeInstruction">é¸æ“‡æ¼”ç¤ºæ¨¡å¼å¾Œï¼ŒæŒ‰ä¸‹æ²»å…·ä¸Šçš„ CALI. æˆ– TEST æŒ‰éµé–‹å§‹è‡ªå‹•æ¼”ç¤º</span>
            </div>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div class="current-info" id="currentInfo">
            <strong>ç•¶å‰ç‹€æ…‹ï¼š</strong><span id="currentStatus">æº–å‚™é–‹å§‹</span>
        </div>
        
        <div id="errorMessage" class="error-message" style="display: none;"></div>
        
        <div class="main-content">
            <div class="flow-diagram">
                <div class="diagram-area">
                    <div class="pc-side" id="pcSide">
                        <h3>ğŸ“± PCç«¯</h3>
                        <div><strong>ç³»çµ±:</strong> Windows 11</div>
                        <div><strong>é€£æ¥:</strong> USBæ¥åŸ </div>
                        <div><strong>åŠŸèƒ½:</strong></div>
                        <ul>
                            <li>Serialé€šè¨Š (Commandç™¼é€)</li>
                            <li>Serialé€šè¨Š (Dataæ¥æ”¶)</li>
                            <li>è³‡æ–™å„²å­˜ .csv æ ¼å¼</li>
                        </ul>
                        <div id="pcStatus" class="status-display">ç­‰å¾…é€£æ¥...</div>
                        
                        <div class="device-controls">
                            <button class="device-button" onclick="sendAsciiCommand()" id="asciiBtn" disabled>ç™¼é€ASCII "1" æŒ‡ä»¤<br><small>ASCII "1" ã‚³ãƒãƒ³ãƒ‰é€ä¿¡</small></button>
                        </div>
                    </div>
                    
                    <div class="connection">
                        <span class="arrow">â¬…</span>
                        <div class="usb-port">USB Port</div>
                        <span class="arrow">â¡</span>
                        <div class="data-flow" id="dataFlow"></div>
                    </div>
                    
                    <div class="device-side" id="deviceSide">
                        <h3>ğŸ”§ JR7æ ¡æ­£æ²»å…·</h3>
                        <div><strong>ç³»çµ± / ã‚·ã‚¹ãƒ†ãƒ :</strong> STM32F407</div>
                        <div><strong>é€£æ¥ / æ¥ç¶š:</strong> USART Port</div>
                        <div><strong>åŠŸèƒ½ / æ©Ÿèƒ½:</strong></div>
                        <ul>
                            <li>Serialé€šè¨Š (Commandæ¥æ”¶)<br><small>ã‚·ãƒªã‚¢ãƒ«é€šä¿¡ï¼ˆã‚³ãƒãƒ³ãƒ‰å—ä¿¡ï¼‰</small></li>
                            <li>Serialé€šè¨Š (Dataè£ç½®)<br><small>ã‚·ãƒªã‚¢ãƒ«é€šä¿¡ï¼ˆãƒ‡ãƒ¼ã‚¿é€ä¿¡ï¼‰</small></li>
                            <li>æ ¡æ­£æ²»å…·æ“ä½œ<br><small>æ ¡æ­£æ²»å…·æ“ä½œ</small></li>
                        </ul>
                        
                        <div class="prerequisite-check">
                            <div>å‰ç½®æ¢ä»¶æª¢æŸ¥ / å‰ææ¡ä»¶ãƒã‚§ãƒƒã‚¯ï¼š</div>
                            <div>âœ… QR CODE: <span id="qrStatus">å·²æƒæ</span></div>
                            <div>âœ… PCé€£ç·š / PCæ¥ç¶š: <span id="pcConnStatus">æ­£å¸¸</span></div>
                        </div>
                        
                        <div class="device-controls">
                            <button class="device-button" onclick="startCalibration()" id="caliBtn">CALI.</button>
                            <button class="device-button" onclick="startTest()" id="testBtn">TEST</button>
                        </div>
                        
                        <div id="deviceStatus" class="status-display">å¾…æ©Ÿä¸­... / å¾…æ©Ÿä¸­...</div>
                        
                        <div class="external-controls">
                            <div>å¤–éƒ¨ç‹€æ…‹æ§åˆ¶ / å¤–éƒ¨çŠ¶æ…‹åˆ¶å¾¡</div>
                            <button class="status-button" onclick="toggleQR()" id="qrButton">å·²æƒæQR CODE</button>
                            <button class="status-button" onclick="togglePC()" id="pcButton">PCç«¯é€£ç·šæ­£å¸¸</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flow-steps">
                <h3>ğŸ“‹ å®Œæ•´æ“ä½œæµç¨‹<br><small style="font-size: 14px; color: #666;">å®Œå…¨æ“ä½œãƒ•ãƒ­ãƒ¼</small></h3>
                <div class="steps-container">
                    <div class="steps-column">
                        <div class="column-title">æ ¡æ­£æµç¨‹ (CALI.)<br><small>æ ¡æ­£ãƒ•ãƒ­ãƒ¼ (CALI.)</small></div>
                        <div class="step-item pending" id="step0">
                            <span class="step-number">0</span>æŒ‰ä¸‹ã€ŒCALI.ã€æŒ‰éµ<br><small>ã€ŒCALI.ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹</small>
                        </div>
                        <div class="step-arrow">â†“</div>
                        <div class="step-item pending" id="step1">
                            <span class="step-number">1</span>é–‹å§‹æ ¡æ­£æ¨¡å¼<br><small>æ ¡æ­£ãƒ¢ãƒ¼ãƒ‰é–‹å§‹</small>
                        </div>
                        <div class="step-arrow">â†“</div>
                        <div class="step-item pending" id="step2">
                            <span class="step-number">2</span>æ ¡æ­£ä¸­...<br><small>æ ¡æ­£ä¸­...</small>
                        </div>
                        <div class="step-arrow">â†“</div>
                        <div class="step-item pending" id="step3">
                            <span class="step-number">3</span>æ ¡æ­£çµæŸåˆ¤å®šçµæœ<br><small>æ ¡æ­£çµ‚äº†çµæœåˆ¤å®š</small>
                        </div>
                        <div class="step-arrow">â†“</div>
                        <div class="step-item pending" id="step4">
                            <span class="step-number">4</span>çµæŸæ ¡æ­£æ¨¡å¼é€²å…¥é™æº«æ¨¡å¼<br><small>æ ¡æ­£ãƒ¢ãƒ¼ãƒ‰çµ‚äº†ã€å†·å´ãƒ¢ãƒ¼ãƒ‰é–‹å§‹</small>
                        </div>
                        <div class="step-arrow">â†“</div>
                    </div>
                    
                    <div class="steps-column">
                        <div class="column-title">æ¸¬è©¦æµç¨‹ (TEST / æ¥çºŒ)<br><small>ãƒ†ã‚¹ãƒˆãƒ•ãƒ­ãƒ¼ (TEST / ç¶™ç¶š)</small></div>
                        <div class="step-item pending" id="step5">
                            <span class="step-number">5</span>æ¸¬è©¦æ¨¡å¼ä¸­...<br><small>ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ä¸­...</small>
                        </div>
                        <div class="step-arrow">â†“</div>
                        <div class="step-item pending" id="step6">
                            <span class="step-number">6</span>æ¸¬è©¦æ¨¡å¼çµæŸ<br><small>ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰çµ‚äº†</small>
                        </div>
                        <div class="step-arrow">â†“</div>
                        <div class="step-item pending" id="step7">
                            <span class="step-number">7</span>å°‡æ ¡æ­£èˆ‡æ¸¬è©¦çµæœå­˜å…¥SDå¡<br><small>æ ¡æ­£ãƒ»ãƒ†ã‚¹ãƒˆçµæœã‚’SDã‚«ãƒ¼ãƒ‰ã«ä¿å­˜</small>
                        </div>
                        <div class="step-arrow">â†“</div>
                        <div class="step-item pending" id="step7-1" style="display: none;">
                            <span class="step-number">7-1</span>âŒ æ¸¬è©¦çµæœNG<br><small>è«‹é¸æ“‡ START(é‡æ–°æ ¡æ­£) æˆ– END(çµæŸæµç¨‹)</small><br><small style="color: #888;">STARTï¼ˆå†æ ¡æ­£ï¼‰ã¾ãŸã¯ENDï¼ˆçµ‚äº†ï¼‰ã‚’é¸æŠ</small>
                        </div>
                        <div class="step-arrow" id="arrow7-1" style="display: none;">â†“</div>
                        <div class="step-item pending" id="step8">
                            <span class="step-number">8</span>ç”Ÿç”¢äººå“¡ç¢ºèªä¸­ï¼Œç­‰å¾…PCç«¯ç™¼é€æŒ‡ä»¤<br><small>ç”Ÿç”£æ‹…å½“è€…ç¢ºèªä¸­ã€PCå´ã‚³ãƒãƒ³ãƒ‰é€ä¿¡å¾…ã¡</small>
                        </div>
                        <div class="step-arrow">â†“</div>
                        <div class="step-item pending" id="step9">
                            <span class="step-number">9</span>æ ¡æ­£æ²»å…·æ¥æ”¶æŒ‡ä»¤æ­£ç¢º<br><small>æ ¡æ­£æ²»å…·ã‚³ãƒãƒ³ãƒ‰å—ä¿¡æ­£å¸¸</small>
                        </div>
                        <div class="step-arrow">â†“</div>
                        <div class="step-item pending" id="step10">
                            <span class="step-number">10</span>å°‡è³‡æ–™é€åˆ°PCç«¯<br><small>ãƒ‡ãƒ¼ã‚¿ã‚’PCå´ã«é€ä¿¡</small>
                        </div>
                        <div class="step-arrow">â†“</div>
                        <div class="step-item pending" id="step11">
                            <span class="step-number">11</span>ğŸ çµæŸæµç¨‹<br><small>ãƒ•ãƒ­ãƒ¼çµ‚äº†</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = -1;
        let autoMode = true;
        let manualMode = false;
        let animationTimer = null;
        let qrScanned = true;
        let pcConnected = true;
        let testNormal = true; // é è¨­æ¸¬è©¦æ­£å¸¸
        let fromAbnormalPath = false; // è¨˜éŒ„æ˜¯å¦ä¾†è‡ªç•°å¸¸è·¯å¾‘
        
        const steps = [
            { device: "æŒ‰ä¸‹CALI.æŒ‰éµ", pc: "é€£ç·šæ­£å¸¸", status: "ç”¨æˆ¶æŒ‰ä¸‹æ²»å…·ä¸Šçš„CALI.æŒ‰éµ<br><small>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ²»å…·ã®CALI.ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹</small>" },
            { device: "é–‹å§‹æ ¡æ­£æ¨¡å¼", pc: "é€£ç·šæ­£å¸¸", status: "æ²»å…·é€²å…¥æ ¡æ­£æ¨¡å¼ï¼Œå»ºç«‹é€šè¨Šé€£æ¥<br><small>æ²»å…·ãŒæ ¡æ­£ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚Šã€é€šä¿¡æ¥ç¶šã‚’ç¢ºç«‹</small>" },
            { device: "æ ¡æ­£ä¸­...", pc: "é€£ç·šæ­£å¸¸", status: "æ²»å…·æ­£åœ¨åŸ·è¡Œæ ¡æ­£ç¨‹åº<br><small>æ²»å…·ãŒæ ¡æ­£ãƒ—ãƒ­ã‚»ã‚¹ã‚’å®Ÿè¡Œä¸­</small>" },
            { device: "æ ¡æ­£çµæŸåˆ¤å®šçµæœ", pc: "é€£ç·šæ­£å¸¸", status: "æ ¡æ­£å®Œæˆï¼Œç³»çµ±åˆ¤å®šæ ¡æ­£çµæœ<br><small>æ ¡æ­£å®Œäº†ã€ã‚·ã‚¹ãƒ†ãƒ ãŒæ ¡æ­£çµæœã‚’åˆ¤å®š</small>" },
            { device: "é€²å…¥é™æº«æ¨¡å¼", pc: "é€£ç·šæ­£å¸¸", status: "æ²»å…·é€²å…¥é™æº«éšæ®µï¼Œç­‰å¾…æº«åº¦ç©©å®š<br><small>æ²»å…·ãŒå†·å´æ®µéšã«å…¥ã‚Šã€æ¸©åº¦å®‰å®šã‚’å¾…æ©Ÿ</small>" },
            { device: "æ¸¬è©¦æ¨¡å¼ä¸­...", pc: "é å‚™æ¥æ”¶è³‡æ–™", status: "é–‹å§‹åŸ·è¡Œæ¸¬è©¦ç¨‹åºï¼Œé€šçŸ¥PCæº–å‚™æ¥æ”¶<br><small>ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹ã€PCå´ã«å—ä¿¡æº–å‚™ã‚’é€šçŸ¥</small>" },
            { device: "æ¸¬è©¦æ¨¡å¼çµæŸ", pc: "é å‚™æ¥æ”¶è³‡æ–™", status: "æ¸¬è©¦å®Œæˆï¼Œæº–å‚™å­˜å„²æ•¸æ“š<br><small>ãƒ†ã‚¹ãƒˆå®Œäº†ã€ãƒ‡ãƒ¼ã‚¿ä¿å­˜æº–å‚™</small>" },
            { device: "ğŸ’¾ å­˜å…¥SDå¡", pc: "é å‚™æ¥æ”¶è³‡æ–™", status: "å°‡æ ¡æ­£èˆ‡æ¸¬è©¦çµæœå­˜å…¥SDå¡<br><small>æ ¡æ­£ãƒ»ãƒ†ã‚¹ãƒˆçµæœã‚’SDã‚«ãƒ¼ãƒ‰ã«ä¿å­˜</small>" },
            { device: "ç­‰å¾…ç¢ºèªä¸­...", pc: "â³ ç­‰å¾…ç™¼é€æŒ‡ä»¤", status: "ç”Ÿç”¢äººå“¡ç¢ºèªä¸­ï¼Œç­‰å¾…PCç«¯ç™¼é€æŒ‡ä»¤<br><small>ç”Ÿç”£æ‹…å½“è€…ç¢ºèªä¸­ã€PCå´ã‚³ãƒãƒ³ãƒ‰é€ä¿¡å¾…ã¡</small>" },
            { device: "âœ… æ¥æ”¶æŒ‡ä»¤æ­£ç¢º", pc: "ğŸ“¤ å·²ç™¼é€æŒ‡ä»¤", status: "æ ¡æ­£æ²»å…·æ¥æ”¶æŒ‡ä»¤æ­£ç¢º<br><small>æ ¡æ­£æ²»å…·ã‚³ãƒãƒ³ãƒ‰å—ä¿¡æ­£å¸¸</small>" },
            { device: "ğŸ”„ å‚³é€æ•¸æ“šåˆ°PC", pc: "ğŸ”„ æ¥æ”¶æ•¸æ“šä¸­...", status: "å°‡è³‡æ–™é€åˆ°PCç«¯<br><small>ãƒ‡ãƒ¼ã‚¿ã‚’PCå´ã«é€ä¿¡</small>" },
            { device: "ğŸ æµç¨‹å®Œæˆ", pc: "ğŸ’¾ æ•¸æ“šå·²å„²å­˜", status: "æ•´å€‹æ ¡æ­£æµç¨‹å®Œæˆï¼Œæ•¸æ“šå·²å®‰å…¨å„²å­˜<br><small>å…¨æ ¡æ­£ãƒ•ãƒ­ãƒ¼å®Œäº†ã€ãƒ‡ãƒ¼ã‚¿å®‰å…¨ä¿å­˜æ¸ˆã¿</small>" }
        ];
        
        const step7_1 = { device: "âŒ æ¸¬è©¦çµæœNG - è«‹é¸æ“‡æ“ä½œ", pc: "ç­‰å¾…ç”¨æˆ¶é¸æ“‡", status: "æ¸¬è©¦çµæœç•°å¸¸ï¼Œè«‹é¸æ“‡é‡æ–°æ ¡æ­£(START)æˆ–çµæŸæµç¨‹(END)<br><small>ãƒ†ã‚¹ãƒˆçµæœç•°å¸¸ã€å†æ ¡æ­£(START)ã¾ãŸã¯çµ‚äº†(END)ã‚’é¸æŠ</small>" };
        
        function checkPrerequisites() {
            return qrScanned && pcConnected;
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 3000);
        }
        
        function updatePrerequisiteDisplay() {
            document.getElementById('qrStatus').textContent = qrScanned ? 'å·²æƒæ' : 'æœªæƒæ';
            document.getElementById('pcConnStatus').textContent = pcConnected ? 'æ­£å¸¸' : 'ç•°å¸¸';
            
            const qrDiv = document.getElementById('qrStatus').parentElement;
            const pcDiv = document.getElementById('pcConnStatus').parentElement;
            
            qrDiv.innerHTML = `${qrScanned ? 'âœ…' : 'âŒ'} QR CODE: <span id="qrStatus">${qrScanned ? 'å·²æƒæ' : 'æœªæƒæ'}</span>`;
            pcDiv.innerHTML = `${pcConnected ? 'âœ…' : 'âŒ'} PCé€£ç·š: <span id="pcConnStatus">${pcConnected ? 'æ­£å¸¸' : 'ç•°å¸¸'}</span>`;
        }
        
        function toggleQR() {
            qrScanned = !qrScanned;
            const button = document.getElementById('qrButton');
            button.textContent = qrScanned ? 'å·²æƒæQR CODE' : 'æœªæƒæQR CODE';
            button.classList.toggle('inactive', !qrScanned);
            updatePrerequisiteDisplay();
        }
        
        function togglePC() {
            pcConnected = !pcConnected;
            const button = document.getElementById('pcButton');
            button.textContent = pcConnected ? 'PCç«¯é€£ç·šæ­£å¸¸' : 'PCç«¯é€£ç·šç•°å¸¸';
            button.classList.toggle('inactive', !pcConnected);
            updatePrerequisiteDisplay();
        }
        
        function updateDisplay() {
            const deviceStatus = document.getElementById('deviceStatus');
            const pcStatus = document.getElementById('pcStatus');
            const progressFill = document.getElementById('progressFill');
            const currentStatus = document.getElementById('currentStatus');
            const asciiBtn = document.getElementById('asciiBtn');
            
            if (currentStep >= 0 && currentStep < steps.length) {
                deviceStatus.textContent = steps[currentStep].device;
                pcStatus.textContent = steps[currentStep].pc;
                
                // ç‰¹æ®Šè™•ç†æ­¥é©Ÿ11çš„ç‹€æ…‹é¡¯ç¤º
                if (currentStep === 11 && fromAbnormalPath) {
                    currentStatus.innerHTML = 'çµæŸæ ¡æ­£èˆ‡æ¸¬è©¦æµç¨‹ï¼Œç„¡å„²å­˜æ•¸æ“š<br><small>æ ¡æ­£ãƒ»ãƒ†ã‚¹ãƒˆãƒ•ãƒ­ãƒ¼çµ‚äº†ã€ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãªã—</small>';
                } else {
                    currentStatus.innerHTML = steps[currentStep].status;
                }
                
                // æ§åˆ¶ASCIIæŒ‰éµçš„å•Ÿç”¨ç‹€æ…‹
                if (currentStep === 8) {
                    asciiBtn.disabled = false;
                } else {
                    asciiBtn.disabled = true;
                }
                
                // æ›´æ–°é€²åº¦æ¢
                const progress = ((currentStep + 1) / steps.length) * 100;
                progressFill.style.width = progress + '%';
                
                // æ›´æ–°æ­¥é©Ÿåˆ—è¡¨
                for (let i = 0; i <= 11; i++) {
                    const stepElement = document.getElementById(`step${i}`);
                    if (stepElement) {
                        stepElement.classList.remove('active', 'completed', 'pending', 'waiting-blink');
                        
                        if (i === currentStep) {
                            stepElement.classList.add('active');
                            // å¦‚æœæ˜¯æ­¥é©Ÿ8ï¼Œæ·»åŠ ç­‰å¾…é–ƒçˆæ•ˆæœ
                            if (i === 8) {
                                stepElement.classList.add('waiting-blink');
                            }
                        } else if (i < currentStep) {
                            stepElement.classList.add('completed');
                        } else {
                            stepElement.classList.add('pending');
                        }
                    }
                }
                
                // æª¢æŸ¥æ˜¯å¦éœ€è¦é¡¯ç¤ºç•°å¸¸æ­¥é©Ÿ
                if (currentStep === 7 && !testNormal) {
                    // åœ¨æ­¥é©Ÿ7ä¸”æ¸¬è©¦ç•°å¸¸æ™‚ï¼Œæº–å‚™é¡¯ç¤º7-1
                    setTimeout(() => {
                        if (autoMode) {
                            nextStep(); // è‡ªå‹•é€²å…¥7-1
                        }
                    }, 3000);
                }
                
                // ç‰¹æ®Šæ•ˆæœè™•ç†
                handleSpecialEffects();
            }
        }
        
        function handleSpecialEffects() {
            const deviceSide = document.getElementById('deviceSide');
            const pcSide = document.getElementById('pcSide');
            const dataFlow = document.getElementById('dataFlow');
            
            // æ¸…é™¤ä¹‹å‰çš„ç‰¹æ•ˆ
            deviceSide.classList.remove('highlight');
            pcSide.classList.remove('highlight');
            dataFlow.classList.remove('device-to-pc', 'pc-to-device', 'notify-pc');
            dataFlow.style.opacity = '0';
            
            switch (currentStep) {
                case 5: // æ¸¬è©¦æ¨¡å¼ä¸­ - ä¸é¡¯ç¤ºæ•¸æ“šæµå‹•ç•«
                    break;
                case 8: // ç­‰å¾…PCç«¯ç™¼é€æŒ‡ä»¤
                    pcSide.classList.add('highlight');
                    dataFlow.textContent = 'â³ ç­‰å¾…æŒ‡ä»¤ç™¼é€...';
                    dataFlow.style.opacity = '1';
                    break;
                case 9: // æ ¡æ­£æ²»å…·æ¥æ”¶æŒ‡ä»¤æ­£ç¢º - PCåˆ°æ²»å…·
                    pcSide.classList.add('highlight');
                    dataFlow.textContent = 'ğŸ“¤ ASCII "1" æŒ‡ä»¤ç™¼é€ä¸­...';
                    dataFlow.classList.add('pc-to-device');
                    dataFlow.style.opacity = '1';
                    setTimeout(() => {
                        deviceSide.classList.add('highlight');
                    }, 1000);
                    break;
                case 10: // è³‡æ–™å‚³é€æ­¥é©Ÿ - æ²»å…·åˆ°PC
                    deviceSide.classList.add('highlight');
                    dataFlow.textContent = 'ğŸ“Š æ ¡æ­£æ•¸æ“šå‚³é€ä¸­...';
                    dataFlow.classList.add('device-to-pc');
                    dataFlow.style.opacity = '1';
                    setTimeout(() => {
                        pcSide.classList.add('highlight');
                    }, 1000);
                    break;
            }
        }
        
        function setAutoMode() {
            autoMode = true;
            manualMode = false;
            
            document.getElementById('autoModeBtn').classList.remove('inactive');
            document.getElementById('manualModeBtn').classList.add('inactive');
            document.getElementById('nextStepBtn').style.display = 'none';
            document.getElementById('modeInstruction').textContent = 'é¸æ“‡æ¼”ç¤ºæ¨¡å¼å¾Œï¼ŒæŒ‰ä¸‹æ²»å…·ä¸Šçš„ CALI. æˆ– TEST æŒ‰éµé–‹å§‹è‡ªå‹•æ¼”ç¤º';
        }
        
        function setManualMode() {
            autoMode = false;
            manualMode = true;
            
            document.getElementById('autoModeBtn').classList.add('inactive');
            document.getElementById('manualModeBtn').classList.remove('inactive');
            document.getElementById('nextStepBtn').style.display = 'inline-block';
            document.getElementById('modeInstruction').textContent = 'é¸æ“‡æ¼”ç¤ºæ¨¡å¼å¾Œï¼ŒæŒ‰ä¸‹æ²»å…·ä¸Šçš„ CALI. æˆ– TEST æŒ‰éµé–‹å§‹ï¼Œç„¶å¾Œé»æ“Šã€Œä¸‹ä¸€æ­¥ã€æ‰‹å‹•æ§åˆ¶æµç¨‹';
        }
        
        function switchToNormalButtons() {
            document.getElementById('caliBtn').textContent = 'CALI.';
            document.getElementById('testBtn').textContent = 'TEST';
            document.getElementById('caliBtn').onclick = startCalibration;
            document.getElementById('testBtn').onclick = startTest;
        }
        
        function switchToNGButtons() {
            document.getElementById('caliBtn').textContent = 'START';
            document.getElementById('testBtn').textContent = 'END';
            document.getElementById('caliBtn').onclick = restartCalibration;
            document.getElementById('testBtn').onclick = endProcess;
        }
        
        function hideAbnormalStep() {
            document.getElementById('step7-1').style.display = 'none';
            document.getElementById('arrow7-1').style.display = 'none';
        }
        
        function showAbnormalStep() {
            document.getElementById('step7-1').style.display = 'block';
            document.getElementById('arrow7-1').style.display = 'block';
        }
        
        function setNormalTest() {
            testNormal = true;
            document.getElementById('normalTestBtn').classList.remove('inactive');
            document.getElementById('abnormalTestBtn').classList.add('inactive');
            hideAbnormalStep();
        }
        
        function setAbnormalTest() {
            testNormal = false;
            document.getElementById('normalTestBtn').classList.add('inactive');
            document.getElementById('abnormalTestBtn').classList.remove('inactive');
        }
        
        function restartCalibration() {
            if (!checkPrerequisites()) {
                showError('ç„¡æ³•é‡æ–°é–‹å§‹ï¼šè«‹ç¢ºèªå·²æƒæQR CODEä¸”PCç«¯é€£ç·šæ­£å¸¸');
                return;
            }
            
            switchToNormalButtons();
            hideAbnormalStep();
            fromAbnormalPath = false; // é‡ç½®ç•°å¸¸è·¯å¾‘æ¨™è¨˜
            stopAnimation();
            currentStep = 1; // è·³åˆ°æ­¥é©Ÿ1é‡æ–°é–‹å§‹æ ¡æ­£
            updateDisplay();
            
            if (autoMode) {
                startAutoAnimation();
            }
        }
        
        function endProcess() {
            switchToNormalButtons();
            hideAbnormalStep();
            stopAnimation();
            fromAbnormalPath = true; // æ¨™è¨˜ä¾†è‡ªç•°å¸¸è·¯å¾‘
            currentStep = 11; // ç›´æ¥è·³åˆ°çµæŸ
            updateDisplay();
        }
        
        function startAutoAnimation() {
            if (autoMode) {
                animationTimer = setInterval(() => {
                    // å¦‚æœåˆ°é”æ­¥é©Ÿ8ï¼Œåœæ­¢è‡ªå‹•å‹•ç•«ï¼Œç­‰å¾…æ‰‹å‹•é»æ“Š
                    if (currentStep === 8) {
                        stopAnimation();
                        return;
                    }
                    
                    if (currentStep < steps.length - 1) {
                        nextStep();
                    } else {
                        stopAnimation();
                    }
                }, 3000);
            }
        }
        
        function stopAnimation() {
            if (animationTimer) {
                clearInterval(animationTimer);
                animationTimer = null;
            }
        }
        
        function nextStep() {
            if (currentStep < steps.length - 1) {
                // æª¢æŸ¥æ˜¯å¦åœ¨æ­¥é©Ÿ7ä¸”è¨­å®šç‚ºæ¸¬è©¦ç•°å¸¸
                if (currentStep === 7 && !testNormal) {
                    // è·³è½‰åˆ°æ­¥é©Ÿ7-1ï¼ˆæ¸¬è©¦çµæœNGï¼‰
                    currentStep = '7-1';
                    updateDisplayForNG();
                    return;
                }
                
                currentStep++;
                
                // å¦‚æœåˆ°é”æ­¥é©Ÿ8ï¼Œåœæ­¢è‡ªå‹•é€²è¡Œï¼Œç­‰å¾…æ‰‹å‹•é»æ“ŠASCIIæŒ‰éµ
                if (currentStep === 8) {
                    updateDisplay();
                    stopAnimation(); // ç¢ºä¿åœæ­¢è‡ªå‹•å‹•ç•«
                    return;
                }
                
                // å¦‚æœæ­£å¸¸æµç¨‹åˆ°é”æ­¥é©Ÿ11ï¼Œé‡ç½®ç•°å¸¸è·¯å¾‘æ¨™è¨˜
                if (currentStep === 11) {
                    fromAbnormalPath = false;
                }
                
                updateDisplay();
            }
        }
        
        function updateDisplayForNG() {
            const deviceStatus = document.getElementById('deviceStatus');
            const pcStatus = document.getElementById('pcStatus');
            const currentStatus = document.getElementById('currentStatus');
            
            deviceStatus.textContent = step7_1.device;
            pcStatus.textContent = step7_1.pc;
            currentStatus.innerHTML = step7_1.status;
            
            // é¡¯ç¤ºç•°å¸¸æ­¥é©Ÿ
            showAbnormalStep();
            
            // æ›´æ–°æ­¥é©Ÿé¡¯ç¤º
            document.getElementById('step7-1').classList.add('active');
            
            // åˆ‡æ›æŒ‰éµ
            switchToNGButtons();
        }
        
        function sendAsciiCommand() {
            if (currentStep === 8) {
                currentStep = 9;
                updateDisplay();
                
                // ç¹¼çºŒè‡ªå‹•æ’­æ”¾å‰©é¤˜æ­¥é©Ÿ
                if (autoMode) {
                    setTimeout(() => {
                        currentStep = 10;
                        updateDisplay();
                        setTimeout(() => {
                            currentStep = 11;
                            updateDisplay();
                        }, 3000);
                    }, 3000);
                }
            }
        }
        
        function reset() {
            stopAnimation();
            currentStep = -1;
            fromAbnormalPath = false; // é‡ç½®ç•°å¸¸è·¯å¾‘æ¨™è¨˜
            switchToNormalButtons();
            hideAbnormalStep();
            document.getElementById('deviceStatus').textContent = 'å¾…æ©Ÿä¸­...';
            document.getElementById('pcStatus').textContent = 'é€£ç·šæ­£å¸¸';
            document.getElementById('currentStatus').innerHTML = 'æº–å‚™é–‹å§‹ - é¸æ“‡ CALI. æˆ– TEST æ¨¡å¼<br><small>é–‹å§‹æº–å‚™ä¸­ - CALI.ã¾ãŸã¯TESTãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠ</small>';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('asciiBtn').disabled = true;
            
            // é‡ç½®æ‰€æœ‰æ­¥é©Ÿ
            for (let i = 0; i <= 11; i++) {
                const stepElement = document.getElementById(`step${i}`);
                if (stepElement) {
                    stepElement.classList.remove('active', 'completed', 'waiting-blink');
                    stepElement.classList.add('pending');
                }
            }
            
            // é‡ç½®7-1æ­¥é©Ÿ
            const step7_1Element = document.getElementById('step7-1');
            if (step7_1Element) {
                step7_1Element.classList.remove('active', 'completed');
                step7_1Element.classList.add('pending');
            }
            
            // æ¸…é™¤ç‰¹æ•ˆ
            document.getElementById('deviceSide').classList.remove('highlight');
            document.getElementById('pcSide').classList.remove('highlight');
            document.getElementById('dataFlow').style.opacity = '0';
        }
        
        function startCalibration() {
            if (!checkPrerequisites()) {
                showError('ç„¡æ³•é–‹å§‹æ ¡æ­£ï¼šè«‹ç¢ºèªå·²æƒæQR CODEä¸”PCç«¯é€£ç·šæ­£å¸¸');
                return;
            }
            
            stopAnimation(); // åœæ­¢ä¹‹å‰çš„å‹•ç•«
            fromAbnormalPath = false; // é‡ç½®ç•°å¸¸è·¯å¾‘æ¨™è¨˜
            currentStep = 0;
            updateDisplay();
            
            if (autoMode) {
                startAutoAnimation();
            }
        }
        
        function startTest() {
            if (!checkPrerequisites()) {
                showError('ç„¡æ³•é–‹å§‹æ¸¬è©¦ï¼šè«‹ç¢ºèªå·²æƒæQR CODEä¸”PCç«¯é€£ç·šæ­£å¸¸');
                return;
            }
            
            stopAnimation(); // åœæ­¢ä¹‹å‰çš„å‹•ç•«
            fromAbnormalPath = false; // é‡ç½®ç•°å¸¸è·¯å¾‘æ¨™è¨˜
            currentStep = 5; // ç›´æ¥å¾æ¸¬è©¦æ¨¡å¼é–‹å§‹
            updateDisplay();
            
            if (autoMode) {
                startAutoAnimation();
            }
        }
        
    </script>
</body>
</html>
